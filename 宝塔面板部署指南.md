# 宝塔面板部署指南

## 项目概述

本项目是一个基于 Node.js + Express + MySQL 的微服务架构项目，包含：
- **Admin 服务**：管理后台 API (端口 3001)
- **H5 服务**：H5 前端 API (端口 3000)

## 部署方式

### 方式一：完整部署（推荐）

使用完整的部署脚本，包含代码拉取、依赖安装、数据库迁移和服务重启：

```bash
# 进入项目目录
cd /www/wwwroot/wx_ziyouyueke_service

# 执行完整部署
./scripts/deploy.sh production
```

### 方式二：快速更新

仅拉取代码并重启服务，适用于小改动：

```bash
# 进入项目目录
cd /www/wwwroot/wx_ziyouyueke_service

# 执行快速更新
./scripts/quick-update.sh
```

### 方式三：手动操作

```bash
# 1. 进入项目目录
cd /www/wwwroot/wx_ziyouyueke_service

# 2. 拉取最新代码
git pull origin main

# 3. 安装依赖（如有新增）
npm install --production

# 4. 运行数据库迁移（如有数据库变更）
npm run migrate

# 5. 重启服务
pm2 restart all
```

## PM2 服务管理

### 查看服务状态
```bash
pm2 status
```

### 查看服务日志
```bash
# 查看所有服务日志
pm2 logs

# 查看特定服务日志
pm2 logs wx_ziyouyueke_admin
pm2 logs wx_ziyouyueke_h5
```

### 重启服务
```bash
# 重启所有服务
pm2 restart all

# 重启特定服务
pm2 restart wx_ziyouyueke_admin
pm2 restart wx_ziyouyueke_h5
```

### 停止服务
```bash
# 停止所有服务
pm2 stop all

# 停止特定服务
pm2 stop wx_ziyouyueke_admin
pm2 stop wx_ziyouyueke_h5
```

### 删除服务
```bash
pm2 delete all
```

## 服务配置

### 生产环境配置
- 配置文件：`ecosystem.production.config.js`
- Admin 服务：单实例，端口 3001
- H5 服务：多实例集群，端口 3000

### 开发环境配置
- 配置文件：`ecosystem.bt.config.js`
- 适用于宝塔面板标准配置

## 环境变量

确保在项目根目录创建 `.env` 文件，包含必要的环境变量：

```env
NODE_ENV=production
DB_HOST=localhost
DB_PORT=3306
DB_NAME=yueke
DB_USER=root
DB_PASSWORD=your_password
JWT_SECRET=your_jwt_secret
# ... 其他配置
```

## 数据库管理

### 自动数据库初始化
- 首次部署：自动创建所有表和默认数据
- 服务重启：自动创建新增的表
- 手动迁移：使用 `npm run migrate` 执行数据库迁移脚本

### 数据库迁移
```bash
# 运行所有迁移脚本
npm run migrate

# 查看迁移状态
ls scripts/001_*.js
```

## 日志管理

### 日志位置
- Admin 服务日志：`logs/admin-*.log`
- H5 服务日志：`logs/h5-*.log`
- PM2 日志：`logs/pm2-*.log`

### 清理日志
```bash
# 使用内置日志清理工具
npm run clean-logs

# 或手动清理
pm2 flush
```

## 故障排除

### 服务启动失败
1. 检查端口是否被占用：`netstat -tlnp | grep :3000`
2. 检查环境变量配置：`cat .env`
3. 查看错误日志：`pm2 logs --err`

### 数据库连接失败
1. 检查数据库服务状态：`systemctl status mysql`
2. 检查数据库配置：确认 `.env` 中的数据库连接信息
3. 检查数据库权限：确保用户有访问权限

### 代码更新后服务异常
1. 检查依赖是否完整：`npm install --production`
2. 检查数据库迁移：`npm run migrate`
3. 重启服务：`pm2 restart all`

## 监控和维护

### 服务监控
```bash
# 实时监控
pm2 monit

# 查看资源使用情况
pm2 show wx_ziyouyueke_admin
pm2 show wx_ziyouyueke_h5
```

### 定期维护
1. 定期清理日志文件
2. 监控服务内存使用情况
3. 定期备份数据库
4. 检查服务运行状态

## 安全建议

1. 定期更新依赖包：`npm audit fix`
2. 使用强密码和安全的 JWT 密钥
3. 配置防火墙规则
4. 定期备份重要数据
5. 监控异常访问日志

## 联系支持

如遇到问题，请检查：
1. 服务日志文件
2. 系统资源使用情况
3. 网络连接状态
4. 数据库服务状态