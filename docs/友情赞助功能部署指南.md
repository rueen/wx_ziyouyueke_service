# 友情赞助功能 - 部署和使用指南

## 📋 功能简介

友情赞助功能允许用户通过微信小程序支付对平台进行赞助。主要特性：

✅ 支持微信小程序支付（JSAPI支付）  
✅ 支持匿名赞助  
✅ 支持留言  
✅ 自动处理支付回调  
✅ 订单超时自动关闭（2小时）  
✅ 完整的管理后台  
✅ 详细的统计数据  

## 📦 已创建的文件

### 核心文件
- `src/shared/models/Donation.js` - 赞助记录数据模型
- `src/shared/utils/wechatPay.js` - 微信支付工具类
- `src/shared/services/wechatPayService.js` - 微信支付服务

### H5端（小程序端）
- `src/h5/controllers/DonationController.js` - 赞助控制器
- `src/h5/routes/donation.js` - 赞助路由

### Admin端（管理端）
- `src/admin/controllers/DonationController.js` - 管理端赞助控制器
- `src/admin/routes/donation.js` - 管理端赞助路由

### 数据库和配置
- `scripts/add-donation-table.js` - 数据库迁移脚本
- `src/shared/config/env.example` - 环境变量示例（已更新）
- `docs/友情赞助功能API文档.md` - API文档

### 已更新的文件
- `src/shared/models/index.js` - 添加了Donation模型和关联关系
- `src/h5/routes/index.js` - 添加了赞助路由
- `src/admin/routes/index.js` - 添加了管理端赞助路由

## 🚀 部署步骤

### 第一步：配置微信支付

#### 1. 开通微信支付

1. 登录[微信支付商户平台](https://pay.weixin.qq.com/)
2. 如果还没有商户号，需要先申请开通微信支付
3. 完成商户认证和信息配置

#### 2. 获取商户API证书

1. 登录微信支付商户平台
2. 进入"账户中心" -> "API安全"
3. 点击"申请API证书"
4. 下载证书工具，按照指引生成证书
5. 下载证书压缩包，解压后得到：
   - `apiclient_cert.pem` - 商户证书
   - `apiclient_key.pem` - 商户私钥（重要！）
6. 在API安全页面可以查看"证书序列号"

#### 3. 设置APIv3密钥

1. 在"账户中心" -> "API安全"页面
2. 点击"设置APIv3密钥"
3. 设置一个32位的密钥（建议使用随机生成器）
4. 妥善保管此密钥

#### 4. 绑定小程序AppID

1. 进入"产品中心" -> "AppID账号管理"
2. 添加关联小程序AppID
3. 等待小程序管理员确认绑定

#### 5. 配置支付回调地址

1. 进入"产品中心" -> "开发配置"
2. **重要**：找到"JSAPI支付回调链接"或"支付回调URL"（不是"Native支付回调链接"）
   - ✅ 正确：JSAPI支付回调链接（用于小程序支付）
   - ❌ 错误：Native支付回调链接（用于扫码支付，PC网站等）
3. 设置回调URL为：`https://your-domain.com/api/h5/donations/notify`
4. ⚠️ 必须使用HTTPS，HTTP不支持

**注意**：
- 小程序支付（JSAPI）使用"JSAPI支付回调链接"
- Native支付（扫码支付）使用"Native支付回调链接"
- 如果找不到"JSAPI支付回调链接"，可能显示为"支付回调URL"或"支付通知URL"

### 第二步：配置服务器环境变量

#### 1. 上传商户证书

将商户私钥文件 `apiclient_key.pem` 上传到服务器安全目录，例如：

```bash
/opt/certs/wechat_pay/apiclient_key.pem
```

**重要安全提示**：
- 不要将证书文件放在Web目录下
- 设置文件权限为仅所有者可读：`chmod 400 apiclient_key.pem`
- 不要将证书文件上传到代码仓库

#### 2. 配置环境变量

编辑服务器的 `.env` 文件，添加以下配置：

```bash
# 微信小程序配置
WECHAT_APP_ID=wx123456789abcdef       # 小程序AppID
WECHAT_APP_SECRET=1234567890abcdef    # 小程序AppSecret

# 微信支付配置
WECHAT_MCH_ID=1234567890              # 商户号
WECHAT_API_V3_KEY=12345678901234567890123456789012  # APIv3密钥（32位）
WECHAT_SERIAL_NO=5B3XXXXXXXXXXXXX     # 商户API证书序列号
WECHAT_PRIVATE_KEY_PATH=/opt/certs/wechat_pay/apiclient_key.pem  # 商户私钥文件路径
WECHAT_NOTIFY_URL=https://your-domain.com/api/h5/donations/notify  # 支付回调地址
```

**配置说明**：
- `WECHAT_MCH_ID`：在商户平台首页查看
- `WECHAT_API_V3_KEY`：您自己设置的32位密钥
- `WECHAT_SERIAL_NO`：在"API安全"页面查看，格式类似 `5B3XXXXXXXXXXXXX`
- `WECHAT_PRIVATE_KEY_PATH`：私钥文件的完整路径
- `WECHAT_NOTIFY_URL`：您的服务器域名 + `/api/h5/donations/notify`

### 第三步：创建数据库表

运行数据库迁移脚本：

```bash
cd /path/to/wx_ziyouyueke_service
node scripts/add-donation-table.js
```

此脚本会自动创建 `donations` 表。

### 第四步：重启服务

```bash
# 如果使用PM2
pm2 restart all

# 或者使用npm
npm run start:h5
npm run start:admin
```

### 第五步：测试支付功能

#### 1. 测试环境配置

如果需要在测试环境测试，可以：

1. 使用微信支付的沙箱环境（需申请）
2. 或者使用1分钱的真实支付进行测试

#### 2. 小程序端测试

在小程序中创建测试页面，调用支付接口：

```javascript
// pages/donation/donation.js
Page({
  // 发起赞助
  async donate() {
    try {
      // 1. 创建订单
      const res = await wx.request({
        url: 'https://your-domain.com/api/h5/donations',
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('token')
        },
        data: {
          amount: 100,  // 1元
          message: '测试赞助',
          is_anonymous: 0
        }
      });

      if (res.data.code !== 200) {
        wx.showToast({ title: res.data.message, icon: 'none' });
        return;
      }

      // 2. 调起支付
      const payResult = await wx.requestPayment({
        timeStamp: res.data.data.timeStamp,
        nonceStr: res.data.data.nonceStr,
        package: res.data.data.package,
        signType: res.data.data.signType,
        paySign: res.data.data.paySign
      });

      // 3. 支付成功
      wx.showToast({ title: '赞助成功', icon: 'success' });
      
      // 4. 刷新订单状态
      this.checkPaymentStatus(res.data.data.donation_id);
      
    } catch (error) {
      console.error('赞助失败', error);
      wx.showToast({ title: '赞助失败', icon: 'none' });
    }
  },

  // 查询支付状态
  async checkPaymentStatus(donationId) {
    const res = await wx.request({
      url: `https://your-domain.com/api/h5/donations/${donationId}/status`,
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      }
    });

    if (res.data.data.payment_status === 1) {
      console.log('支付成功确认');
    }
  }
});
```

#### 3. 查看日志

查看服务器日志，确认支付流程：

```bash
# 查看今日日志
tail -f logs/2025-11-23.log

# 或者查看shared日志
tail -f src/shared/logs/2025-11-23.log
```

应该看到类似的日志：

```
[INFO] 创建赞助订单: { donation_id: 1, user_id: 1, amount: 100 }
[INFO] 微信支付下单成功: { out_trade_no: 'DON...', prepay_id: 'wx...' }
[INFO] 收到支付回调通知: { out_trade_no: 'DON...', trade_state: 'SUCCESS' }
[INFO] 订单支付成功: { donation_id: 1, transaction_id: '4200...' }
```

## 🔧 故障排查

### 1. 支付下单失败

**错误信息**：签名验证失败

**解决方法**：
- 检查 `WECHAT_SERIAL_NO` 是否正确
- 检查 `WECHAT_PRIVATE_KEY_PATH` 文件路径是否正确
- 检查私钥文件是否有读取权限

**错误信息**：AppID与商户号不匹配

**解决方法**：
- 确认小程序AppID已经在商户平台绑定
- 检查 `.env` 中的 `WECHAT_APP_ID` 和 `WECHAT_MCH_ID` 是否正确

### 2. 支付回调未收到

**可能原因**：
- 回调URL配置错误
- 服务器防火墙阻止了微信服务器的请求
- 服务器未使用HTTPS

**解决方法**：
- 确认商户平台配置的回调URL正确
- 测试回调URL是否可以从外网访问
- 确保使用HTTPS（微信支付不支持HTTP回调）

### 3. 订单状态未更新

**可能原因**：
- 回调处理失败
- 数据库连接问题

**解决方法**：
- 查看服务器日志，确认回调是否被正确处理
- 手动调用查询订单状态接口：`GET /api/h5/donations/:id/status`
- 这个接口会主动查询微信支付订单状态并同步到本地

### 4. 证书路径问题

**错误信息**：Cannot read private key

**解决方法**：
- 使用绝对路径，不要使用相对路径
- 检查文件权限：`ls -l /path/to/apiclient_key.pem`
- 确保Node.js进程有权限读取该文件

## 📱 小程序前端开发建议

### 1. 赞助页面示例

```html
<!-- pages/donation/donation.wxml -->
<view class="donation-page">
  <view class="amount-select">
    <view class="amount-item" 
          wx:for="{{amounts}}" 
          wx:key="index"
          data-amount="{{item}}"
          bindtap="selectAmount">
      {{item / 100}}元
    </view>
  </view>

  <textarea 
    placeholder="留言（选填）" 
    maxlength="200"
    bindinput="onMessageInput"
  ></textarea>

  <checkbox-group bindchange="onAnonymousChange">
    <label>
      <checkbox value="1" />匿名赞助
    </label>
  </checkbox-group>

  <button bindtap="donate">确认赞助</button>
</view>
```

### 2. 赞助列表页面

```html
<!-- pages/donation/list.wxml -->
<view class="donation-list">
  <view class="item" wx:for="{{list}}" wx:key="id">
    <image class="avatar" src="{{item.avatar_url || '/images/default-avatar.png'}}" />
    <view class="info">
      <text class="nickname">{{item.nickname}}</text>
      <text class="amount">¥{{item.amount / 100}}</text>
      <text class="message">{{item.message}}</text>
      <text class="time">{{item.paid_at}}</text>
    </view>
  </view>
</view>
```

## 🔐 安全建议

1. **证书安全**：
   - 商户私钥文件不要上传到代码仓库
   - 设置合适的文件权限（仅所有者可读）
   - 定期更换APIv3密钥

2. **接口安全**：
   - 所有接口都需要登录认证（除公开列表）
   - 支付回调需要验证微信签名（生产环境需完善）
   - 限制单笔赞助金额上限

3. **数据安全**：
   - 敏感信息加密存储
   - 定期备份数据库
   - 日志中不记录完整的证书和密钥信息

## 📊 运营建议

1. **定期检查**：
   - 每日检查支付是否正常
   - 定期查看订单数据和统计
   - 关注异常订单（长时间未支付等）

2. **数据分析**：
   - 使用管理端统计接口查看赞助数据
   - 分析用户赞助行为
   - 优化赞助金额选项

3. **用户互动**：
   - 在赞助列表展示留言
   - 考虑添加感谢功能（如需要）
   - 定期向赞助用户表达感谢

## 📞 技术支持

如遇到问题，请：

1. 查看服务器日志
2. 检查微信支付商户平台的交易记录
3. 参考本文档的故障排查章节
4. 查看微信支付官方文档：https://pay.weixin.qq.com/doc/v3

---

## 附录：完整的接口列表

### H5端接口
- `POST /api/h5/donations` - 创建赞助订单
- `GET /api/h5/donations/:id` - 查询订单详情
- `GET /api/h5/donations/my/list` - 我的赞助记录
- `GET /api/h5/donations/list/public` - 公开赞助列表
- `GET /api/h5/donations/:id/status` - 查询支付状态
- `POST /api/h5/donations/notify` - 支付回调（微信调用）

### Admin端接口
- `GET /api/admin/donations` - 赞助列表
- `GET /api/admin/donations/statistics` - 赞助统计
- `GET /api/admin/donations/:id` - 赞助详情
- `PUT /api/admin/donations/:id/remark` - 更新备注

详细的接口文档请参考：`docs/友情赞助功能API文档.md`

