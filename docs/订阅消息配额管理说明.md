# 订阅消息配额管理功能说明

## 功能概述

订阅消息配额管理功能用于在业务侧维护用户的订阅消息剩余次数，实现：

- **余量统计**：记录用户每种模板的订阅次数
- **前端提示**：前端可查询余量，决定是否提示用户订阅
- **状态同步**：根据微信API返回结果自动同步本地配额

## 设计原则

1. **以微信为准**：直接发送消息，根据微信返回结果反向校正本地配额
2. **不做强校验**：发送前不检查本地余量，避免状态漂移导致的误判
3. **自动同步**：
   - 发送成功 → 扣减1次配额
   - 失败且错误码43101（次数用尽）→ 重置配额为0
4. **按模板管理**：每种消息模板独立统计配额

## 数据库表结构

### user_subscribe_quotas 表

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| user_id | BIGINT UNSIGNED | 用户ID |
| template_type | VARCHAR(50) | 模板类型（BOOKING_CONFIRM等） |
| template_id | VARCHAR(100) | 微信模板ID |
| remaining_quota | INT UNSIGNED | 剩余可发送次数 |
| total_quota | INT UNSIGNED | 总授权次数（累计） |
| last_authorized_at | DATETIME | 最近授权时间 |
| last_sent_at | DATETIME | 最近发送时间 |

**索引**：
- `uk_user_template`：唯一索引（user_id, template_type）
- `idx_user_id`：用户查询索引
- `idx_template_type`：模板类型索引
- `idx_remaining_quota`：余量统计索引

**创建脚本**：`scripts/005_create_user_subscribe_quotas_table.js`

## API 接口

### 1. 获取所有可用模板

```
GET /api/h5/wechat/subscribe-templates
```

**说明**：返回系统中所有可用的订阅消息模板信息

**响应示例**：
```json
{
  "code": 200,
  "message": "获取模板列表成功",
  "data": {
    "list": [
      {
        "templateType": "BOOKING_CONFIRM",
        "templateId": "5UyBW3TXEbdAlvdb_eV_5H6qePB0aEFlVc9ow67ZOXE",
        "title": "预约确认提醒",
        "description": "你作为被预约方，收到预约确认提醒"
      },
      {
        "templateType": "BOOKING_SUCCESS",
        "templateId": "TFL2352DnixMHPBHiOg955ByXWBZWXTvk7g05ywsAnw",
        "title": "预约成功通知",
        "description": "课程确认成功后，用于通知预约发起人"
      },
      {
        "templateType": "BOOKING_CANCEL",
        "templateId": "7ziRVg9Gnp4huLb3q4v48ylR2z-kCOkEoM5-8Ad-Hkg",
        "title": "课程取消通知",
        "description": "课程取消后，向另一方发送提醒"
      }
    ]
  }
}
```

### 2. 获取用户配额

```
GET /api/h5/wechat/subscribe-quotas
```

**说明**：获取当前登录用户在各模板的剩余次数

**需要认证**：是

**响应示例**：
```json
{
  "code": 200,
  "message": "获取配额成功",
  "data": {
    "list": [
      {
        "templateType": "BOOKING_CONFIRM",
        "templateId": "5UyBW3TXEbdAlvdb_eV_5H6qePB0aEFlVc9ow67ZOXE",
        "remainingQuota": 2,
        "totalQuota": 5,
        "lastAuthorizedAt": "2025-11-09T12:30:00Z",
        "lastSentAt": "2025-11-09T14:20:00Z"
      },
      {
        "templateType": "BOOKING_SUCCESS",
        "templateId": "TFL2352DnixMHPBHiOg955ByXWBZWXTvk7g05ywsAnw",
        "remainingQuota": 1,
        "totalQuota": 3,
        "lastAuthorizedAt": "2025-11-09T12:30:00Z",
        "lastSentAt": null
      },
      {
        "templateType": "BOOKING_CANCEL",
        "templateId": "7ziRVg9Gnp4huLb3q4v48ylR2z-kCOkEoM5-8Ad-Hkg",
        "remainingQuota": 1,
        "totalQuota": 1,
        "lastAuthorizedAt": "2025-11-09T12:30:00Z",
        "lastSentAt": "2025-11-10T09:00:00Z"
      }
    ]
  }
}
```

### 3. 上报授权结果

```
POST /api/h5/wechat/subscribe-quotas
```

**说明**：前端调用 `wx.requestSubscribeMessage` 后，将授权结果上报给后端

**需要认证**：是

**请求参数**：
```json
{
  "results": [
    {
      "templateType": "BOOKING_CONFIRM",
      "status": "accept"
    },
    {
      "templateType": "BOOKING_SUCCESS",
      "status": "accept"
    },
    {
      "templateType": "BOOKING_CANCEL",
      "status": "accept"
    }
  ]
}
```

**参数说明**：
- `results`：授权结果数组
  - `templateType`：模板类型
  - `status`：授权状态
    - `accept`：用户同意（增加配额）
    - `reject`：用户拒绝
    - `ban`：被封禁

**响应示例**：
```json
{
  "code": 200,
  "message": "授权结果已记录",
  "data": {
    "updated": [
      {
        "templateType": "BOOKING_CONFIRM",
        "templateId": "5UyBW3TXEbdAlvdb_eV_5H6qePB0aEFlVc9ow67ZOXE",
        "remainingQuota": 3,
        "totalQuota": 6
      },
      {
        "templateType": "BOOKING_SUCCESS",
        "templateId": "TFL2352DnixMHPBHiOg955ByXWBZWXTvk7g05ywsAnw",
        "remainingQuota": 2,
        "totalQuota": 4
      },
      {
        "templateType": "BOOKING_CANCEL",
        "templateId": "7ziRVg9Gnp4huLb3q4v48ylR2z-kCOkEoM5-8Ad-Hkg",
        "remainingQuota": 1,
        "totalQuota": 1
      }
    ]
  }
}
```

## 前端集成指南

### 1. 页面初始化

```javascript
// 获取所有可用模板（可缓存）
const templatesRes = await wx.request({
  url: `${baseUrl}/api/h5/wechat/subscribe-templates`,
  method: 'GET'
});

const templates = templatesRes.data.list;
// 保存到全局变量或缓存
```

### 2. 查询用户配额

```javascript
// 获取用户配额
const quotasRes = await wx.request({
  url: `${baseUrl}/api/h5/wechat/subscribe-quotas`,
  method: 'GET',
  header: {
    Authorization: `Bearer ${token}`
  }
});

const quotas = quotasRes.data.list;

// 检查是否有足够配额
const bookingConfirmQuota = quotas.find(q => 
  q.templateType === 'BOOKING_CONFIRM'
);

if (!bookingConfirmQuota || bookingConfirmQuota.remainingQuota === 0) {
  // 提示用户需要订阅
  showSubscribeHint();
}
```

### 3. 请求用户授权

```javascript
// 在用户操作前请求授权
const templateIds = [
  '5UyBW3TXEbdAlvdb_eV_5H6qePB0aEFlVc9ow67ZOXE', // BOOKING_CONFIRM
  'TFL2352DnixMHPBHiOg955ByXWBZWXTvk7g05ywsAnw',   // BOOKING_SUCCESS
  '7ziRVg9Gnp4huLb3q4v48ylR2z-kCOkEoM5-8Ad-Hkg'    // BOOKING_CANCEL
];

wx.requestSubscribeMessage({
  tmplIds: templateIds,
  success: async (res) => {
    // 构建上报数据
    const results = Object.keys(res).map(templateId => {
      // 根据模板ID查找对应的类型
      const template = templates.find(t => t.templateId === templateId);
      return {
        templateType: template.templateType,
        status: res[templateId] // 'accept', 'reject', 'ban'
      };
    });

    // 上报授权结果
    await wx.request({
      url: `${baseUrl}/api/h5/wechat/subscribe-quotas`,
      method: 'POST',
      header: {
        Authorization: `Bearer ${token}`
      },
      data: { results }
    });

    // 继续业务操作
    submitBooking();
  },
  fail: (err) => {
    console.error('授权失败:', err);
  }
});
```

### 4. 推荐的使用时机

- **关键操作前**：创建预约、确认课程等操作前，检查配额并引导授权
- **首次使用**：用户首次使用相关功能时，主动引导订阅
- **配额不足时**：当检测到配额为0时，在合适的时机提示用户

## 配额自动管理

### 发送消息后的处理

系统在发送订阅消息后，会根据微信API返回结果自动更新配额：

#### 1. 发送成功（errcode = 0）

```
发送消息成功
    ↓
扣减配额 -1
    ↓
更新 last_sent_at
```

#### 2. 发送失败（errcode = 43101）

```
微信返回 43101（用户未授权/次数用尽）
    ↓
重置 remaining_quota = 0
    ↓
与微信保持一致
```

#### 3. 其他错误

```
其他错误（网络、参数等）
    ↓
不修改配额
    ↓
记录错误日志
```

### 实现位置

配额管理逻辑在 `SubscribeMessageService` 中：

```javascript
// 发送成功
if (sendResult.success) {
  await UserSubscribeQuota.decreaseQuota(receiverUser.id, 'BOOKING_CONFIRM', 1);
}

// 发送失败且次数用尽
if (sendResult.errcode === 43101) {
  await UserSubscribeQuota.resetQuota(receiverUser.id, 'BOOKING_CONFIRM');
}
```

## 扩展新模板

当需要添加新的订阅消息模板时：

### 1. 在 SubscribeMessageService 中添加模板

```javascript
static TEMPLATES = {
  BOOKING_CONFIRM: '...',
  BOOKING_SUCCESS: '...',
  NEW_TEMPLATE: 'new_template_id'  // 新增
};
```

### 2. 在 WeChatController 中添加描述

```javascript
const descriptions = {
  'BOOKING_CONFIRM': { /* ... */ },
  'BOOKING_SUCCESS': { /* ... */ },
  'NEW_TEMPLATE': {
    title: '新模板标题',
    description: '新模板描述'
  }
};
```

### 3. 在发送方法中添加配额管理

参考现有的 `sendBookingConfirmNotice` 方法，在新的发送方法中添加配额管理逻辑。

## 注意事项

1. **不做前置校验**：发送消息前不检查本地配额，避免误判
2. **以微信为准**：始终以微信API返回结果为准，反向校正本地状态
3. **幂等性保证**：授权上报可能重复，需要在业务层面做好去重
4. **缓存策略**：模板列表可以缓存，配额信息需要实时查询
5. **用户体验**：合理选择订阅引导时机，避免过度打扰

## 相关文档

- [订阅消息功能说明](./订阅消息功能说明.md)
- [订阅消息防重机制说明](./订阅消息防重机制说明.md)
- [微信订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-message-management/subscribe-message/sendMessage.html)

