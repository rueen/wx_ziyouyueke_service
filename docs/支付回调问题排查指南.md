# 支付回调问题排查指南

## 问题现象

微信商户端已收到款，但数据库中的 `payment_status` 仍为 0（待支付状态）。

## 可能原因

### 1. 回调URL未配置或配置错误
- 回调URL未在微信支付商户平台配置
- 回调URL配置错误（域名、路径不匹配）
- 回调URL无法从外网访问

### 2. 回调未被调用
- 服务器防火墙阻止了微信服务器的请求
- 回调URL未使用HTTPS（微信支付要求HTTPS）
- 服务器网络问题

### 3. 回调处理失败
- 签名验证失败（当前代码是简化版本，直接返回true）
- 数据解密失败
- 数据库更新失败
- 异常被捕获但未正确处理

### 4. 回调处理成功但返回错误
- 返回给微信的响应格式不正确
- HTTP状态码不是200
- 微信认为处理失败，会重试

## 排查步骤

### 第一步：检查回调是否被调用

#### 1. 查看服务器日志

```bash
# 查看今日日志
tail -f logs/$(date +%Y-%m-%d).log

# 或者查看shared日志
tail -f src/shared/logs/$(date +%Y-%m-%d).log
```

**查找关键词**：
- `收到支付回调`
- `收到支付回调通知`
- `处理支付回调失败`
- `支付回调签名验证失败`

#### 2. 检查回调接口访问日志

如果使用Nginx，查看访问日志：
```bash
tail -f /var/log/nginx/access.log | grep donations/notify
```

如果使用PM2，查看PM2日志：
```bash
pm2 logs | grep notify
```

#### 3. 检查回调URL配置

1. 登录微信支付商户平台
2. 进入"产品中心" -> "开发配置"
3. **重要**：找到"JSAPI支付回调链接"或"支付回调URL"（不是"Native支付回调链接"）
   - ✅ 正确：JSAPI支付回调链接（用于小程序支付）
   - ❌ 错误：Native支付回调链接（用于扫码支付，PC网站等）
4. 确认URL为：`https://your-domain.com/api/h5/donations/notify`
5. 确认URL可以从外网访问（使用浏览器或curl测试）

**注意**：
- 小程序支付（JSAPI）使用"JSAPI支付回调链接"
- Native支付（扫码支付）使用"Native支付回调链接"
- 如果找不到"JSAPI支付回调链接"，可能显示为"支付回调URL"或"支付通知URL"

### 第二步：检查回调处理逻辑

#### 1. 查看回调处理日志

如果看到 `收到支付回调` 但没有看到 `订单支付成功`，说明回调被调用了但处理失败。

**检查点**：
- 签名验证是否通过
- 数据解密是否成功
- 订单是否找到
- 数据库更新是否成功

#### 2. 检查回调数据格式

微信支付回调的数据结构应该是：
```json
{
  "id": "xxx",
  "create_time": "2025-11-23T10:00:00+08:00",
  "resource_type": "encrypt-resource",
  "event_type": "TRANSACTION.SUCCESS",
  "summary": "支付成功",
  "resource": {
    "original_type": "transaction",
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "...",
    "associated_data": "transaction",
    "nonce": "..."
  }
}
```

### 第三步：手动触发状态同步

如果回调确实没有收到，可以手动查询微信订单状态并更新：

```javascript
// 调用查询订单状态接口
GET /api/h5/donations/:id/status
```

这个接口会：
1. 查询微信支付订单状态
2. 如果微信返回已支付，自动更新本地订单状态

### 第四步：检查代码问题

#### 当前代码存在的问题

1. **签名验证简化**：`verifyNotifySignature` 方法直接返回 `true`，没有真正验证签名
2. **解密可能失败**：`decryptNotifyResource` 方法可能无法正确解密数据
3. **错误处理不完善**：某些异常可能被捕获但没有记录详细信息

## 解决方案

### 方案1：临时解决方案（推荐）

使用查询订单状态接口手动同步：

1. 在小程序中调用：
```javascript
wx.request({
  url: '/api/h5/donations/' + donationId + '/status',
  method: 'GET',
  success: (res) => {
    console.log('订单状态已同步', res);
  }
});
```

2. 或者在管理后台添加"同步订单状态"功能

### 方案2：修复回调处理（长期方案）

需要完善以下功能：

1. **实现完整的签名验证**
2. **修复数据解密逻辑**
3. **增强错误日志记录**
4. **添加回调重试机制**

### 方案3：检查回调URL配置

1. 确认回调URL正确配置
2. 测试回调URL可访问性
3. 检查服务器防火墙规则
4. 确认使用HTTPS

## 调试技巧

### 1. 添加详细日志

在回调处理中添加更多日志：

```javascript
static async paymentNotify(req, res) {
  // 记录原始请求
  logger.info('收到回调请求:', {
    method: req.method,
    url: req.url,
    headers: req.headers,
    body: req.body,
    rawBody: JSON.stringify(req.body)
  });
  
  // ... 处理逻辑
}
```

### 2. 使用微信支付商户平台查看回调记录

1. 登录微信支付商户平台
2. 进入"交易中心" -> "交易查询"
3. 找到对应的订单
4. 查看"回调记录"，可以看到：
   - 回调URL
   - 回调时间
   - 回调状态（成功/失败）
   - 回调响应内容

### 3. 测试回调URL

使用curl测试回调URL是否可访问：

```bash
curl -X POST https://your-domain.com/api/h5/donations/notify \
  -H "Content-Type: application/json" \
  -H "Wechatpay-Timestamp: 1234567890" \
  -H "Wechatpay-Nonce: abc123" \
  -H "Wechatpay-Signature: xxx" \
  -H "Wechatpay-Serial: xxx" \
  -d '{"test": "data"}'
```

## 常见错误及解决方法

### 错误1：回调URL返回404

**原因**：路由配置错误或URL路径不匹配

**解决**：
- 检查路由配置：`src/h5/routes/donation.js`
- 确认路由已注册：`src/h5/routes/index.js`
- 测试URL路径是否正确

### 错误2：回调URL返回500

**原因**：回调处理逻辑出错

**解决**：
- 查看服务器错误日志
- 检查数据库连接
- 检查代码异常处理

### 错误3：签名验证失败

**原因**：当前代码签名验证是简化版本

**解决**：
- 暂时跳过签名验证（已实现）
- 后续实现完整的签名验证逻辑

### 错误4：数据解密失败

**原因**：解密逻辑不正确或APIv3密钥错误

**解决**：
- 检查 `WECHAT_API_V3_KEY` 配置是否正确
- 检查解密逻辑是否正确
- 查看错误日志中的详细信息

## 预防措施

1. **添加监控**：监控回调接口的调用情况
2. **定期同步**：定期查询未支付订单，主动同步状态
3. **完善日志**：记录所有回调处理的详细信息
4. **实现重试**：如果回调处理失败，实现重试机制
5. **告警机制**：如果订单长时间未更新状态，发送告警

## 紧急处理

如果急需更新订单状态，可以直接在数据库中更新：

```sql
-- 注意：需要先确认微信支付确实已收到款
UPDATE donations 
SET payment_status = 1, 
    transaction_id = '微信支付订单号',
    paid_at = NOW()
WHERE id = 订单ID;
```

**⚠️ 警告**：直接修改数据库需要谨慎，建议先通过查询接口同步状态。

