# è¯¾æ—¶æœ‰æ•ˆæœŸåŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## éœ€æ±‚èƒŒæ™¯

æ•™ç»ƒåˆ›å»ºè¯¾ç¨‹åˆ†ç±»æ—¶å¯è®¾ç½®æœ‰æ•ˆæœŸï¼ˆå¦‚"30å¤©20èŠ‚è¯¾åŒ…"ï¼‰ï¼Œæ¯ä¸ªåˆ†ç±»ç‹¬ç«‹åˆ°æœŸæ—¶é—´ï¼Œåˆ°æœŸåè¯¥åˆ†ç±»çš„å‰©ä½™è¯¾æ—¶è‡ªåŠ¨æ¸…é›¶ã€‚

## æ•°æ®ç»“æ„

åœ¨ `student_coach_relations.lessons` JSON å­—æ®µä¸­ï¼Œä¸ºæ¯ä¸ªåˆ†ç±»æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

```json
[
  {
    "category_id": 0, 
    "remaining_lessons": 20, 
    "expire_date": null,
    "is_cleared": false,
    "original_lessons": 20
  },
  {
    "category_id": 1, 
    "remaining_lessons": 15, 
    "expire_date": "2025-02-01",
    "is_cleared": false,
    "original_lessons": 20
  },
  {
    "category_id": 2, 
    "remaining_lessons": 0, 
    "expire_date": "2025-01-15",
    "is_cleared": true,
    "original_lessons": 30
  }
]
```

### å­—æ®µè¯´æ˜

- `expire_date`: æ ¼å¼ `YYYY-MM-DD`ï¼Œ`null` è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼Œåˆ°æœŸæ—¶é—´ä¸ºå½“å¤© 23:59:59
- `is_cleared`: æ˜¯å¦å·²æ¸…é›¶æ ‡è®°ï¼Œé¿å…é‡å¤æ¸…é›¶å’Œé¢‘ç¹å†™æ•°æ®åº“
- `original_lessons`: æ¸…é›¶å‰çš„åŸå§‹è¯¾æ—¶æ•°ï¼Œç”¨äºæ“ä½œæ—¥å¿—è®°å½•
- `remaining_lessons`: åˆ°æœŸåè‡ªåŠ¨æ¸…é›¶ä¸º 0

## æ ¸å¿ƒé€»è¾‘

1. æ•™ç»ƒè®¾ç½® `expire_date` æ·»åŠ /æ›´æ–°è¯¾æ—¶æ—¶ï¼Œåˆå§‹åŒ– `is_cleared: false` å’Œ `original_lessons`
2. `getCategoryLessons()` ç»Ÿä¸€æ£€æŸ¥è¿‡æœŸï¼š
   - æ£€æŸ¥ `is_cleared` æ ‡è®°ï¼Œå·²æ¸…é›¶ç›´æ¥è¿”å› 0ï¼Œé¿å…é‡å¤å¤„ç†
   - æœªæ¸…é›¶ä½†å·²è¿‡æœŸï¼šæ¸…é›¶è¯¾æ—¶ã€è®¾ç½®æ ‡è®°ã€è®°å½•æ“ä½œæ—¥å¿—
3. æ‰£è¯¾æ—¶æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œé€šè¿‡ `getCategoryLessons()` è·å–æœ‰æ•ˆè¯¾æ—¶
4. å®šæ—¶ä»»åŠ¡æ‰¹é‡å¤„ç†è¿‡æœŸè¯¾æ—¶ï¼Œé¿å…é¢‘ç¹æ•°æ®åº“å†™å…¥

## æ—¶åŒºå¤„ç†

- ç»Ÿä¸€ä½¿ç”¨ **Asia/Shanghai** æ—¶åŒº
- åˆ°æœŸåˆ¤æ–­ï¼š`expire_date` å½“å¤©çš„ **23:59:59** ä¸ºæˆªæ­¢æ—¶é—´
- æ¨èä½¿ç”¨ `moment-timezone` åº“å¤„ç†æ—¥æœŸæ¯”è¾ƒ

```javascript
const moment = require('moment-timezone');

// åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
function isExpired(expireDate) {
  if (!expireDate) return false;
  const expireEndTime = moment.tz(expireDate, 'Asia/Shanghai').endOf('day');
  const now = moment.tz('Asia/Shanghai');
  return now.isAfter(expireEndTime);
}
```

## API å˜æ›´

### æ›´æ–°å¸ˆç”Ÿå…³ç³»

**æ¥å£ï¼š** `PUT /api/h5/relations/:id`

```json
{
  "category_lessons": [
    {
      "category_id": 1,
      "remaining_lessons": 20,
      "expire_date": "2025-02-01"
    }
  ]
}
```

**è¯´æ˜ï¼š**
- `expire_date` æ ¼å¼ï¼š`YYYY-MM-DD`
- ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ– `is_cleared: false` å’Œ `original_lessons`

### æŸ¥è¯¢æ¥å£å“åº”

åœ¨ `category_lessons` ä¸­è¿”å› `expire_date` å’Œ `is_expired` å­—æ®µï¼š

```json
{
  "category_id": 1,
  "remaining_lessons": 15,
  "expire_date": "2025-02-01",
  "is_expired": false
}
```

## ä»£ç ä¿®æ”¹

### 1. æ¨¡å‹å±‚ï¼ˆStudentCoachRelation.jsï¼‰

#### å®‰è£…ä¾èµ–

```bash
npm install moment-timezone
```

#### `getCategoryLessons()` å¢åŠ è¿‡æœŸæ£€æŸ¥

```javascript
const moment = require('moment-timezone');
const { OperationLog } = require('./index');

/**
 * è·å–æŒ‡å®šåˆ†ç±»çš„å‰©ä½™è¯¾æ—¶ï¼ˆå«è¿‡æœŸæ£€æŸ¥ï¼‰
 * @param {number} categoryId - åˆ†ç±»ID
 * @returns {number} å‰©ä½™è¯¾æ—¶æ•°
 */
async getCategoryLessons(categoryId) {
  const lessons = this.lessons || [];
  const category = lessons.find(l => l.category_id === categoryId);
  
  if (!category) return 0;
  
  // å·²æ¸…é›¶ï¼Œç›´æ¥è¿”å›
  if (category.is_cleared) return 0;
  
  // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
  if (category.expire_date) {
    const expireEndTime = moment.tz(category.expire_date, 'Asia/Shanghai').endOf('day');
    const now = moment.tz('Asia/Shanghai');
    
    if (now.isAfter(expireEndTime)) {
      // è®°å½•æ¸…é›¶å‰çš„è¯¾æ—¶æ•°
      const clearedLessons = category.remaining_lessons;
      
      // æ¸…é›¶è¯¾æ—¶å¹¶æ ‡è®°
      category.original_lessons = category.original_lessons || clearedLessons;
      category.remaining_lessons = 0;
      category.is_cleared = true;
      
      await this.save();
      
      // è®°å½•æ“ä½œæ—¥å¿—
      await OperationLog.create({
        user_id: this.student_id,
        operation_type: 'lesson_expire',
        operation_desc: `è¯¾æ—¶è¿‡æœŸè‡ªåŠ¨æ¸…é›¶: åˆ†ç±»${categoryId}æ¸…é›¶${clearedLessons}èŠ‚è¯¾`,
        table_name: 'student_coach_relations',
        record_id: this.id,
        old_data: {
          category_id: categoryId,
          remaining_lessons: clearedLessons,
          expire_date: category.expire_date
        },
        new_data: {
          category_id: categoryId,
          remaining_lessons: 0,
          expire_date: category.expire_date,
          is_cleared: true,
          coach_id: this.coach_id
        },
        ip_address: null,
        user_agent: 'System-Cron'
      });
      
      return 0;
    }
  }
  
  return category.remaining_lessons || 0;
}
```

#### `decreaseCategoryLessons()` ä½¿ç”¨äº‹åŠ¡

```javascript
/**
 * æ‰£å‡æŒ‡å®šåˆ†ç±»çš„è¯¾æ—¶
 * @param {number} categoryId - åˆ†ç±»ID
 * @param {number} amount - æ‰£å‡æ•°é‡
 * @param {Object} transaction - æ•°æ®åº“äº‹åŠ¡å¯¹è±¡ï¼ˆå¯é€‰ï¼‰
 * @returns {boolean} æ˜¯å¦æ‰£å‡æˆåŠŸ
 */
async decreaseCategoryLessons(categoryId, amount = 1, transaction = null) {
  // å…ˆæ£€æŸ¥æœ‰æ•ˆè¯¾æ—¶
  const availableLessons = await this.getCategoryLessons(categoryId);
  
  if (availableLessons < amount) {
    return false;
  }
  
  const lessons = this.lessons || [];
  const category = lessons.find(l => l.category_id === categoryId);
  
  if (!category) return false;
  
  category.remaining_lessons -= amount;
  
  await this.save({ transaction });
  
  return true;
}
```

#### `getAvailableLessons()` è‡ªåŠ¨æ’é™¤è¿‡æœŸ

```javascript
/**
 * è·å–æ‰€æœ‰å¯ç”¨è¯¾æ—¶ï¼ˆè‡ªåŠ¨æ’é™¤è¿‡æœŸï¼‰
 * @returns {Array} å¯ç”¨è¯¾æ—¶åˆ—è¡¨
 */
async getAvailableLessons() {
  const lessons = this.lessons || [];
  const available = [];
  
  for (const lesson of lessons) {
    const remaining = await this.getCategoryLessons(lesson.category_id);
    if (remaining > 0) {
      available.push({
        category_id: lesson.category_id,
        remaining_lessons: remaining,
        expire_date: lesson.expire_date
      });
    }
  }
  
  return available;
}
```

### 2. æ§åˆ¶å™¨å±‚

#### RelationController.updateRelation()

```javascript
/**
 * æ›´æ–°å¸ˆç”Ÿå…³ç³»ï¼ˆå«è¯¾æ—¶ï¼‰
 */
async updateRelation(req, res) {
  const { id } = req.params;
  const { category_lessons } = req.body;
  
  try {
    const relation = await StudentCoachRelation.findByPk(id);
    
    if (category_lessons) {
      // éªŒè¯ expire_date æ ¼å¼
      for (const lesson of category_lessons) {
        if (lesson.expire_date && !moment(lesson.expire_date, 'YYYY-MM-DD', true).isValid()) {
          return res.status(400).json({ message: 'æ—¥æœŸæ ¼å¼é”™è¯¯ï¼Œåº”ä¸º YYYY-MM-DD' });
        }
        
        // åˆå§‹åŒ–æ–°å­—æ®µ
        lesson.is_cleared = false;
        lesson.original_lessons = lesson.remaining_lessons;
      }
      
      relation.lessons = category_lessons;
      await relation.save();
    }
    
    res.json({ message: 'æ›´æ–°æˆåŠŸ', data: relation });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}
```

#### RelationController æŸ¥è¯¢æ–¹æ³•

```javascript
/**
 * æŸ¥è¯¢æ•™ç»ƒåˆ—è¡¨/å­¦å‘˜åˆ—è¡¨
 */
async getMyCoaches(req, res) {
  try {
    const relations = await StudentCoachRelation.findAll({
      where: { student_id: req.user.id }
    });
    
    // éå†è§¦å‘è¿‡æœŸæ£€æŸ¥å¹¶è¿”å›çŠ¶æ€
    for (const relation of relations) {
      const lessons = relation.lessons || [];
      for (const lesson of lessons) {
        await relation.getCategoryLessons(lesson.category_id); // è§¦å‘æ£€æŸ¥
        
        // æ·»åŠ  is_expired å­—æ®µ
        if (lesson.expire_date) {
          const expireEndTime = moment.tz(lesson.expire_date, 'Asia/Shanghai').endOf('day');
          const now = moment.tz('Asia/Shanghai');
          lesson.is_expired = now.isAfter(expireEndTime);
        } else {
          lesson.is_expired = false;
        }
      }
    }
    
    res.json({ data: relations });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}
```

#### CourseController - å®Œæˆè¯¾ç¨‹ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰

```javascript
const { sequelize } = require('../models');

/**
 * å®Œæˆè¯¾ç¨‹å¹¶æ‰£è¯¾æ—¶
 */
async completeCourse(req, res) {
  const { id } = req.params;
  const t = await sequelize.transaction();
  
  try {
    const booking = await CourseBooking.findByPk(id, { transaction: t });
    
    if (!booking) {
      await t.rollback();
      return res.status(404).json({ message: 'è¯¾ç¨‹ä¸å­˜åœ¨' });
    }
    
    // è·å–å¸ˆç”Ÿå…³ç³»
    const relation = await StudentCoachRelation.findOne({
      where: {
        student_id: booking.student_id,
        coach_id: booking.coach_id
      },
      transaction: t
    });
    
    // æ‰£å‡è¯¾æ—¶ï¼ˆè‡ªåŠ¨æ£€æŸ¥è¿‡æœŸï¼‰
    const success = await relation.decreaseCategoryLessons(
      booking.category_id, 
      1, 
      t
    );
    
    if (!success) {
      await t.rollback();
      return res.status(400).json({ message: 'è¯¾æ—¶ä¸è¶³æˆ–å·²è¿‡æœŸ' });
    }
    
    // æ›´æ–°è¯¾ç¨‹çŠ¶æ€
    booking.status = 'completed';
    await booking.save({ transaction: t });
    
    await t.commit();
    
    res.json({ message: 'è¯¾ç¨‹å®Œæˆ', data: booking });
  } catch (error) {
    await t.rollback();
    res.status(500).json({ message: error.message });
  }
}
```

### 3. æ•°æ®è¿ç§»

åˆ›å»ºè¿ç§»è„šæœ¬ `scripts/add_expire_fields_to_lessons.js`ï¼š

```javascript
const { StudentCoachRelation } = require('../src/shared/models');

/**
 * ä¸ºç°æœ‰è¯¾æ—¶æ•°æ®æ·»åŠ è¿‡æœŸç›¸å…³å­—æ®µ
 */
async function migrate() {
  try {
    const relations = await StudentCoachRelation.findAll();
    
    for (const relation of relations) {
      if (!relation.lessons || relation.lessons.length === 0) continue;
      
      let updated = false;
      for (const lesson of relation.lessons) {
        // æ·»åŠ æ–°å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (lesson.expire_date === undefined) {
          lesson.expire_date = null; // æ°¸ä¹…æœ‰æ•ˆ
          lesson.is_cleared = false;
          lesson.original_lessons = lesson.remaining_lessons || 0;
          updated = true;
        }
      }
      
      if (updated) {
        await relation.save();
        console.log(`Updated relation ${relation.id}`);
      }
    }
    
    console.log('Migration completed successfully');
    process.exit(0);
  } catch (error) {
    console.error('Migration failed:', error);
    process.exit(1);
  }
}

migrate();
```

æ‰§è¡Œè¿ç§»ï¼š
```bash
node scripts/add_expire_fields_to_lessons.js
```

### 4. å®šæ—¶ä»»åŠ¡ï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰

æ¯å¤©å‡Œæ™¨ 2:00 æ‰¹é‡æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸè¯¾æ—¶ï¼Œåªå¤„ç†éœ€è¦æ¸…é›¶çš„è®°å½•ã€‚

åˆ›å»º `src/shared/services/lessonExpireService.js`ï¼š

```javascript
const moment = require('moment-timezone');
const { StudentCoachRelation, OperationLog, sequelize } = require('../models');

class LessonExpireService {
  /**
   * æ‰¹é‡å¤„ç†è¿‡æœŸè¯¾æ—¶
   */
  async processExpiredLessons() {
    console.log('[å®šæ—¶ä»»åŠ¡] å¼€å§‹æ£€æŸ¥è¿‡æœŸè¯¾æ—¶:', moment().format('YYYY-MM-DD HH:mm:ss'));
    
    const t = await sequelize.transaction();
    let processedCount = 0;
    let clearedCount = 0;
    
    try {
      // æŸ¥è¯¢æ‰€æœ‰æœ‰æ•ˆçš„å¸ˆç”Ÿå…³ç³»
      const relations = await StudentCoachRelation.findAll({
        where: { relation_status: 1 },
        transaction: t
      });
      
      const now = moment.tz('Asia/Shanghai');
      const operations = [];
      
      for (const relation of relations) {
        if (!relation.lessons || relation.lessons.length === 0) continue;
        
        let needUpdate = false;
        
        for (const lesson of relation.lessons) {
          // è·³è¿‡å·²æ¸…é›¶æˆ–æ— è¿‡æœŸæ—¥æœŸçš„
          if (lesson.is_cleared || !lesson.expire_date) continue;
          
          const expireEndTime = moment.tz(lesson.expire_date, 'Asia/Shanghai').endOf('day');
          
          // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
          if (now.isAfter(expireEndTime)) {
            const clearedLessons = lesson.remaining_lessons;
            
            // æ¸…é›¶å¤„ç†
            lesson.original_lessons = lesson.original_lessons || clearedLessons;
            lesson.remaining_lessons = 0;
            lesson.is_cleared = true;
            needUpdate = true;
            
            // è®°å½•æ“ä½œæ—¥å¿—
            operations.push({
              user_id: relation.student_id,
              operation_type: 'lesson_expire',
              operation_desc: `è¯¾æ—¶è¿‡æœŸè‡ªåŠ¨æ¸…é›¶: åˆ†ç±»${lesson.category_id}æ¸…é›¶${clearedLessons}èŠ‚è¯¾`,
              table_name: 'student_coach_relations',
              record_id: relation.id,
              old_data: {
                category_id: lesson.category_id,
                remaining_lessons: clearedLessons,
                expire_date: lesson.expire_date
              },
              new_data: {
                category_id: lesson.category_id,
                remaining_lessons: 0,
                expire_date: lesson.expire_date,
                is_cleared: true,
                coach_id: relation.coach_id
              },
              ip_address: null,
              user_agent: 'System-Cron'
            });
            
            clearedCount++;
          }
        }
        
        if (needUpdate) {
          await relation.save({ transaction: t });
          processedCount++;
        }
      }
      
      // æ‰¹é‡æ’å…¥æ“ä½œæ—¥å¿—
      if (operations.length > 0) {
        await OperationLog.bulkCreate(operations, { transaction: t });
      }
      
      await t.commit();
      
      console.log(`[å®šæ—¶ä»»åŠ¡] å®Œæˆ: å¤„ç† ${processedCount} ä¸ªå…³ç³», æ¸…é›¶ ${clearedCount} ä¸ªè¯¾æ—¶åŒ…`);
    } catch (error) {
      await t.rollback();
      console.error('[å®šæ—¶ä»»åŠ¡] æ‰§è¡Œå¤±è´¥:', error);
    }
  }
}

module.exports = new LessonExpireService();
```

åœ¨ `src/shared/app-common.js` æˆ–æœåŠ¡å¯åŠ¨æ–‡ä»¶ä¸­æ³¨å†Œå®šæ—¶ä»»åŠ¡ï¼š

```javascript
const cron = require('node-cron');
const lessonExpireService = require('./services/lessonExpireService');

// æ¯å¤©å‡Œæ™¨ 2:00 æ‰§è¡Œ
cron.schedule('0 2 * * *', async () => {
  await lessonExpireService.processExpiredLessons();
});

console.log('å®šæ—¶ä»»åŠ¡å·²æ³¨å†Œ: æ¯å¤©å‡Œæ™¨ 2:00 æ£€æŸ¥è¿‡æœŸè¯¾æ—¶');
```

å®‰è£…ä¾èµ–ï¼š
```bash
npm install node-cron
```

## è¿‡æœŸæ£€æŸ¥æ—¶æœº

### å®æ—¶æ£€æŸ¥ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

é€šè¿‡ `is_cleared` æ ‡è®°é¿å…é‡å¤æ£€æŸ¥ï¼Œåªåœ¨ä»¥ä¸‹å…³é”®æ“ä½œæ—¶è§¦å‘ï¼š

1. **æŸ¥è¯¢æ•™ç»ƒ/å­¦å‘˜åˆ—è¡¨** (`GET /api/h5/relations/my-coaches`, `my-students`)
   - è°ƒç”¨ `getCategoryLessons()` è§¦å‘è¿‡æœŸæ£€æŸ¥
   - è¿”å› `is_expired` çŠ¶æ€å­—æ®µ

2. **é¢„çº¦è¯¾ç¨‹** (`POST /api/h5/courses`)
   - è°ƒç”¨ `getAvailableLessons()` è·å–å¯ç”¨è¯¾æ—¶
   - è‡ªåŠ¨æ’é™¤å·²è¿‡æœŸè¯¾æ—¶

3. **å®Œæˆè¯¾ç¨‹æ‰£è¯¾æ—¶** (`PUT /api/h5/courses/:id/complete`)
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - é€šè¿‡ `getCategoryLessons()` è·å–æœ‰æ•ˆè¯¾æ—¶
   - å·²é¢„çº¦ä½†æœªå®Œæˆçš„è¯¾ç¨‹å…è®¸ç»§ç»­å®Œæˆ

4. **æŸ¥è¯¢è¯¾æ—¶è¯¦æƒ…** (`GET /api/h5/relations/:id`)
   - è¿”å›è¯¦ç»†çš„è¿‡æœŸçŠ¶æ€

5. **å›¢è¯¾æŠ¥å/ç­¾åˆ°**
   - æ£€æŸ¥è¯¾æ—¶æœ‰æ•ˆæ€§

### å®šæ—¶ä»»åŠ¡å…œåº•

æ¯å¤©å‡Œæ™¨ 2:00 æ‰¹é‡å¤„ç†ï¼š
- åªå¤„ç†æœªæ¸…é›¶ä¸”æœ‰è¿‡æœŸæ—¥æœŸçš„è®°å½•
- ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- æ‰¹é‡æ’å…¥æ“ä½œæ—¥å¿—
- é€‚åˆå¤„ç†é•¿æœŸä¸æ´»è·ƒç”¨æˆ·

## è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. å·²é¢„çº¦æœªå®Œæˆçš„è¯¾ç¨‹
- **å¤„ç†æ–¹å¼**ï¼šå…è®¸ç»§ç»­å®Œæˆ
- **å®ç°**ï¼š`completeCourse` æ—¶æ£€æŸ¥è¯¾æ—¶ï¼Œä½†ä¸é˜»æ­¢å·²é¢„çº¦çš„è¯¾ç¨‹å®Œæˆ

### 2. å»¶æœŸéœ€æ±‚
- **å¤„ç†æ–¹å¼**ï¼šä¸æä¾›å»¶æœŸæ¥å£
- **æ“ä½œæµç¨‹**ï¼šæ•™ç»ƒåœ¨å­¦å‘˜è¯¦æƒ…æ‰‹åŠ¨ä¿®æ”¹ `expire_date`
- **æƒé™æ§åˆ¶**ï¼šä»…æ•™ç»ƒå¯æ“ä½œ

### 3. è¯¾æ—¶åŒ…å åŠ è´­ä¹°
- **åœºæ™¯**ï¼šå­¦å‘˜çº¿ä¸‹è½¬è´¦è´­ä¹°è¯¾ç¨‹
- **æ“ä½œæµç¨‹**ï¼š
  1. å­¦å‘˜çº¿ä¸‹è½¬é’±ç»™æ•™ç»ƒ
  2. æ•™ç»ƒåœ¨å­¦å‘˜è¯¦æƒ…æ‰‹åŠ¨ç»´æŠ¤å‰©ä½™è¯¾æ—¶
  3. æ•™ç»ƒæ‰‹åŠ¨è®¾ç½®æˆ–æ›´æ–° `expire_date`
- **æ³¨æ„**ï¼šç³»ç»Ÿä¸æ”¯æŒåœ¨çº¿è´­ä¹°ï¼Œæ‰€æœ‰è¯¾æ—¶ç”±æ•™ç»ƒæ‰‹åŠ¨ç»´æŠ¤

### 4. æ—¶åŒºä¸€è‡´æ€§
- ç»Ÿä¸€ä½¿ç”¨ **Asia/Shanghai** æ—¶åŒº
- åˆ°æœŸæ—¶é—´ä¸ºå½“å¤© **23:59:59**
- æ‰€æœ‰æ—¥æœŸæ¯”è¾ƒä½¿ç”¨ `moment-timezone`

## æ“ä½œæ—¥å¿—

### å­˜å‚¨ä½ç½®

æ“ä½œæ—¥å¿—å­˜å‚¨åœ¨æ•°æ®åº“è¡¨ï¼š**`operation_logs`**

ä½¿ç”¨ç°æœ‰çš„ `OperationLog` æ¨¡å‹ï¼ˆä½äº `src/shared/models/OperationLog.js`ï¼‰

### è‡ªåŠ¨è®°å½•å†…å®¹

è¯¾æ—¶æ¸…é›¶æ—¶è‡ªåŠ¨è®°å½•åˆ° `operation_logs` è¡¨ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| `user_id` | BIGINT | å­¦å‘˜ID | `12345` |
| `operation_type` | VARCHAR(50) | æ“ä½œç±»å‹ | `lesson_expire` |
| `operation_desc` | VARCHAR(200) | æ“ä½œæè¿° | `è¯¾æ—¶è¿‡æœŸè‡ªåŠ¨æ¸…é›¶: åˆ†ç±»1æ¸…é›¶20èŠ‚è¯¾` |
| `table_name` | VARCHAR(50) | æ¶‰åŠè¡¨å | `student_coach_relations` |
| `record_id` | BIGINT | è®°å½•IDï¼ˆå…³ç³»IDï¼‰ | `678` |
| `old_data` | JSON | æ“ä½œå‰æ•°æ® | è§ä¸‹æ–¹ç¤ºä¾‹ |
| `new_data` | JSON | æ“ä½œåæ•°æ® | è§ä¸‹æ–¹ç¤ºä¾‹ |
| `ip_address` | VARCHAR(50) | IPåœ°å€ | `null`ï¼ˆç³»ç»Ÿæ“ä½œï¼‰ |
| `user_agent` | VARCHAR(500) | ç”¨æˆ·ä»£ç† | `System-Cron`ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ |

### æ—¥å¿—æ•°æ®ç¤ºä¾‹

**old_dataï¼ˆæ¸…é›¶å‰ï¼‰ï¼š**
```json
{
  "category_id": 1,
  "remaining_lessons": 20,
  "expire_date": "2025-02-01"
}
```

**new_dataï¼ˆæ¸…é›¶åï¼‰ï¼š**
```json
{
  "category_id": 1,
  "remaining_lessons": 0,
  "expire_date": "2025-02-01",
  "is_cleared": true,
  "coach_id": 9876
}
```

### æŸ¥è¯¢ç¤ºä¾‹

æŸ¥è¯¢æŸä¸ªå­¦å‘˜çš„è¯¾æ—¶æ¸…é›¶å†å²ï¼š
```javascript
const logs = await OperationLog.findAll({
  where: {
    user_id: studentId,
    operation_type: 'lesson_expire'
  },
  order: [['createdAt', 'DESC']]
});
```

æŸ¥è¯¢æŸä¸ªæ•™ç»ƒä¸‹æ‰€æœ‰å­¦å‘˜çš„è¯¾æ—¶æ¸…é›¶è®°å½•ï¼š
```javascript
const { Op } = require('sequelize');

const logs = await OperationLog.findAll({
  where: {
    operation_type: 'lesson_expire',
    'new_data.coach_id': coachId
  },
  order: [['createdAt', 'DESC']]
});
```

### æ—¥å¿—ç”¨é€”

- ğŸ“ **è¿½æº¯è¯¾æ—¶æ¸…é›¶å†å²**ï¼šæŸ¥çœ‹å“ªäº›è¯¾æ—¶ä½•æ—¶è¢«æ¸…é›¶
- ğŸ” **å¤„ç†ç”¨æˆ·çº çº·**ï¼šæä¾›å®Œæ•´çš„æ“ä½œè®°å½•è¯æ®
- ğŸ“Š **æ•°æ®å®¡è®¡**ï¼šç³»ç»Ÿè‡ªåŠ¨æ“ä½œçš„å®¡è®¡è¿½è¸ª
- ğŸ“ˆ **ç»Ÿè®¡åˆ†æ**ï¼šåˆ†æè¯¾æ—¶è¿‡æœŸç‡ã€æŸå¤±ç»Ÿè®¡ç­‰

## æ³¨æ„äº‹é¡¹

### æŠ€æœ¯è¦ç‚¹

1. **æ—¥æœŸæ ¼å¼**ï¼šç»Ÿä¸€ä½¿ç”¨ `YYYY-MM-DD`ï¼Œåˆ°æœŸæ—¶é—´ä¸ºå½“å¤© 23:59:59
2. **å‘åå…¼å®¹**ï¼šç°æœ‰æ•°æ®è‡ªåŠ¨è¡¥å…… `expire_date: null`ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ `is_cleared` æ ‡è®°é¿å…é‡å¤æ¸…é›¶å’Œé¢‘ç¹å†™æ•°æ®åº“
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šå…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡å¤„ç†
5. **æ“ä½œæ—¥å¿—**ï¼šè‡ªåŠ¨è®°å½•è¯¾æ—¶æ¸…é›¶æ“ä½œï¼Œä¾¿äºè¿½æº¯

### æ•°æ®å®Œæ•´æ€§

1. **æ¸…é›¶åä¿ç•™å†å²**ï¼š`original_lessons` ä¿å­˜åŸå§‹è¯¾æ—¶æ•°
2. **è¿‡æœŸæ—¥æœŸä¸å˜**ï¼š`expire_date` ä¿ç•™ä½œä¸ºå†å²è®°å½•
3. **æ¸…é›¶æ ‡è®°**ï¼š`is_cleared` é˜²æ­¢é‡å¤å¤„ç†

### ä¸šåŠ¡è§„åˆ™

1. **æ‰‹åŠ¨ç»´æŠ¤**ï¼šæ•™ç»ƒå¯éšæ—¶è°ƒæ•´å­¦å‘˜è¯¾æ—¶å’Œè¿‡æœŸæ—¶é—´
2. **å·²é¢„çº¦è¯¾ç¨‹**ï¼šè¿‡æœŸåä¸å½±å“å·²é¢„çº¦æœªå®Œæˆçš„è¯¾ç¨‹
3. **å®šæ—¶ä»»åŠ¡**ï¼šæ¯å¤©å‡Œæ™¨ 2:00 æ‰¹é‡å¤„ç†ï¼Œå…œåº•æœºåˆ¶

## å®æ–½æ­¥éª¤

1. âœ… å®‰è£…ä¾èµ–ï¼š`npm install moment-timezone node-cron`
2. âœ… æ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬
3. âœ… æ›´æ–° `StudentCoachRelation` æ¨¡å‹
4. âœ… æ›´æ–°æ§åˆ¶å™¨å±‚ä»£ç 
5. âœ… åˆ›å»ºå®šæ—¶ä»»åŠ¡æœåŠ¡
6. âœ… æ³¨å†Œå®šæ—¶ä»»åŠ¡
7. âœ… æµ‹è¯•å„ä¸ªåœºæ™¯
8. âœ… éƒ¨ç½²ä¸Šçº¿
