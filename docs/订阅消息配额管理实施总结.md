# 订阅消息配额管理功能实施总结

## 实施时间

2025-11-09

## 功能概述

本次实施完成了订阅消息配额管理功能，实现业务侧维护用户订阅消息剩余次数，配合前端授权管理，提升消息送达率和用户体验。

## 核心设计

- **以微信为准**：直接发送消息，根据微信API返回结果反向校正本地配额
- **自动同步**：发送成功扣减配额，失败时（errcode=43101）重置为0
- **按模板管理**：每种消息模板独立统计配额

## 新增文件

### 1. 数据库迁移脚本
**文件**：`scripts/005_create_user_subscribe_quotas_table.js`

**功能**：创建 `user_subscribe_quotas` 表

**运行方法**：
```bash
node scripts/005_create_user_subscribe_quotas_table.js
```

### 2. 数据模型
**文件**：`src/shared/models/UserSubscribeQuota.js`

**主要方法**：
- `getOrCreate()` - 获取或创建配额记录
- `increaseQuota()` - 增加配额（用户授权时）
- `decreaseQuota()` - 减少配额（发送成功时）
- `resetQuota()` - 重置配额为0（同步微信状态）
- `getUserQuotas()` - 获取用户所有配额

### 3. 控制器
**文件**：`src/h5/controllers/WeChatController.js`

**接口**：
- `GET /api/h5/wechat/subscribe-templates` - 获取所有可用模板
- `GET /api/h5/wechat/subscribe-quotas` - 获取用户配额
- `POST /api/h5/wechat/subscribe-quotas` - 上报授权结果

### 4. 路由配置
**文件**：`src/h5/routes/wechat.js`

**说明**：定义微信相关功能路由

### 5. 文档
**文件**：`docs/订阅消息配额管理说明.md`

**内容**：完整的功能说明、API文档、前端集成指南

## 修改文件

### 1. 模型注册
**文件**：`src/shared/models/index.js`

**变更**：
- 引入 `UserSubscribeQuota` 模型
- 添加 User 与 UserSubscribeQuota 的关联关系
- 导出新模型

### 2. 订阅消息服务
**文件**：`src/shared/services/subscribeMessageService.js`

**变更**：
- 引入 `UserSubscribeQuota` 模型
- 在 `sendBookingConfirmNotice()` 中添加配额管理：
  - 发送成功 → 扣减配额
  - 失败且errcode=43101 → 重置配额为0
- 在 `sendBookingSuccessNotice()` 中添加配额管理（同上）

### 3. 主路由
**文件**：`src/h5/routes/index.js`

**变更**：
- 引入 wechat 路由
- 注册 `/wechat` 路径

## 数据库表结构

### user_subscribe_quotas

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | BIGINT UNSIGNED | 主键 |
| user_id | BIGINT UNSIGNED | 用户ID |
| template_type | VARCHAR(50) | 模板类型 |
| template_id | VARCHAR(100) | 微信模板ID |
| remaining_quota | INT UNSIGNED | 剩余次数 |
| total_quota | INT UNSIGNED | 总次数（累计） |
| last_authorized_at | DATETIME | 最近授权时间 |
| last_sent_at | DATETIME | 最近发送时间 |

**索引**：
- `uk_user_template` (UNIQUE): user_id + template_type
- `idx_user_id`: user_id
- `idx_template_type`: template_type
- `idx_remaining_quota`: remaining_quota

## API接口

### 1. 获取模板列表
```
GET /api/h5/wechat/subscribe-templates
```
- 无需认证
- 返回所有可用的订阅消息模板

### 2. 获取用户配额
```
GET /api/h5/wechat/subscribe-quotas
```
- 需要认证
- 返回当前用户在各模板的剩余次数

### 3. 上报授权结果
```
POST /api/h5/wechat/subscribe-quotas
```
- 需要认证
- 接收前端的授权结果，增加用户配额

## 配额管理流程

### 用户授权流程
```
前端调用 wx.requestSubscribeMessage
    ↓
用户同意授权（status = accept）
    ↓
前端上报授权结果到后端
    ↓
后端调用 UserSubscribeQuota.increaseQuota()
    ↓
remaining_quota += 1
total_quota += 1
```

### 发送消息流程
```
触发业务操作（创建预约/确认课程）
    ↓
调用 SubscribeMessageService 发送消息
    ↓
调用微信API
    ↓
根据返回结果处理配额：
  - errcode = 0（成功）→ decreaseQuota(-1)
  - errcode = 43101（次数用尽）→ resetQuota(0)
  - 其他错误 → 不处理配额
```

## 前端集成要点

1. **页面初始化**：获取模板列表（可缓存）
2. **检查配额**：在关键操作前查询用户配额
3. **引导授权**：配额不足时引导用户订阅
4. **上报结果**：授权后立即上报结果给后端

## 测试验证

### 1. 数据库迁移
```bash
# 运行迁移脚本
node scripts/005_create_user_subscribe_quotas_table.js

# 验证表是否创建
mysql> SHOW TABLES LIKE 'user_subscribe_quotas';
mysql> DESC user_subscribe_quotas;
```

### 2. 测试授权上报
```bash
# 使用 Postman 测试
POST /api/h5/wechat/subscribe-quotas
Authorization: Bearer <token>

{
  "results": [
    {"templateType": "BOOKING_CONFIRM", "status": "accept"}
  ]
}
```

### 3. 测试配额查询
```bash
GET /api/h5/wechat/subscribe-quotas
Authorization: Bearer <token>
```

### 4. 测试自动扣减
```bash
# 创建课程预约，触发消息发送
POST /api/h5/courses

# 查看配额是否自动扣减
GET /api/h5/wechat/subscribe-quotas
```

## 注意事项

1. **先运行数据库迁移**：确保 `user_subscribe_quotas` 表已创建
2. **配额不做强校验**：发送前不检查配额，以微信返回为准
3. **错误码43101**：表示用户未授权或次数用尽，此时重置本地配额
4. **授权去重**：前端需避免短时间内重复上报同一授权
5. **模板扩展**：新增模板时需同步更新代码和文档

## 相关文档

- [订阅消息功能说明](./订阅消息功能说明.md)
- [订阅消息配额管理说明](./订阅消息配额管理说明.md)
- [订阅消息防重机制说明](./订阅消息防重机制说明.md)

## 完成标记

✅ 所有任务已完成，功能可正常使用

