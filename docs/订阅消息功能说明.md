# 微信小程序订阅消息功能说明

## 功能概述

本项目已集成微信小程序订阅消息功能，用于在关键业务场景向用户发送通知消息。订阅消息采用异步发送方式，不会阻塞业务响应。

## 技术架构

### 核心文件

1. **订阅消息服务类**
   - 文件路径：`src/shared/services/subscribeMessageService.js`
   - 职责：封装订阅消息发送逻辑，提供统一的消息发送接口
   - 特点：高内聚、低耦合，易于扩展新的消息场景

2. **消息发送记录模型**
   - 文件路径：`src/shared/models/SubscribeMessageLog.js`
   - 职责：记录所有订阅消息的发送情况
   - 特点：防重机制、发送历史追溯、统计分析支持

3. **微信工具类**
   - 文件路径：`src/shared/utils/wechat.js`
   - 职责：与微信 API 交互，获取 access_token，发送订阅消息

4. **业务集成**
   - 文件路径：`src/h5/controllers/CourseController.js`
   - 集成点：
     - `createBooking` 方法：创建预约后发送预约确认提醒
     - `confirmCourse` 方法：确认预约后发送预约成功通知

### 设计原则

- **配额预检查**：发送前检查本地配额，配额为0时直接跳过，避免无效API调用（v2.0新增）
- **防重机制**：通过唯一索引和双重检查确保同一消息不会重复发送（含并发防重）
- **异步发送**：使用 `setImmediate` 在下一个事件循环中发送消息，不阻塞 API 响应
- **容错处理**：消息发送失败不影响主业务流程，仅记录日志
- **状态追踪**：完整记录消息发送状态（发送中、成功、失败）
- **参数验证**：严格验证必要参数，确保消息内容完整
- **字符限制**：根据微信规范限制字段长度，防止发送失败
- **配额同步**：以微信API返回为准，自动同步本地配额状态

## 已实现场景

### 场景一：预约确认提醒

**模板ID**: `5UyBW3TXEbdAlvdb_eV_5H6qePB0aEFlVc9ow67ZOXE`

**触发时机**: 学员或教练创建课程预约后

**业务场景**:
1. **学员预约课程 → 通知教练**
   - 预约人：学员名称（来源：`student_coach_relations.student_name` 或 `users.nickname`）
   - 预约时段：格式如 `2025-11-10 19:00 - 20:00`
   - 预约地址：来源 `addresses.name`
   - 预约状态：待确认

2. **教练预约课程 → 通知学员**
   - 预约人：教练名称（来源：`users.nickname`）
   - 预约时段：同上
   - 预约地址：同上
   - 预约状态：待确认

**跳转页面**: `pages/courseDetail/courseDetail?id={课程ID}`

**消息模板字段映射**:
```javascript
{
  thing7: {
    value: bookerName  // 预约人姓名，最大20字符
  },
  time8: {
    value: timeSlot    // 预约时段，格式：YYYY-MM-DD HH:mm - HH:mm
  },
  thing9: {
    value: addressName // 预约地址，最大20字符
  },
  thing13: {
    value: '待确认'     // 预约状态
  }
}
```

### 场景二：预约成功通知

**模板ID**: 待配置（环境变量 `TEMPLATE_BOOKING_SUCCESS`）

**触发时机**: 教练或学员确认课程预约后

**业务场景**:
1. **教练已确认课程 → 通知发起预约的学员**
   - 课程名称：来源 `users.course_categories[category_id].name`
   - 上课时间：格式如 `2025-11-10 19:00 - 20:00`
   - 上课地点：来源 `addresses.name`
   - 备注：学员备注（来源：`course_bookings.student_remark`）

2. **学员已确认课程 → 通知发起预约的教练**
   - 课程名称：同上
   - 上课时间：同上
   - 上课地点：同上
   - 备注：教练备注（来源：`course_bookings.coach_remark`）

**跳转页面**: `pages/courseDetail/courseDetail?id={课程ID}`

**消息模板字段映射**:
```javascript
{
  thing41: {
    value: categoryName  // 课程名称，最大20字符
  },
  time43: {
    value: timeSlot      // 上课时间，格式：YYYY-MM-DD HH:mm - HH:mm
  },
  thing44: {
    value: addressName   // 上课地点，最大20字符
  },
  thing4: {
    value: remark        // 备注，最大20字符
  }
}
```

### 场景三：课程取消通知

**模板ID**: `7ziRVg9Gnp4huLb3q4v48ylR2z-kCOkEoM5-8Ad-Hkg`

**触发时机**: 课程被取消后（学员或教练取消）

**业务场景**:
- 课程取消 → 通知另一方（未取消的一方将收到提醒）

**字段映射**:
- 上课时间：来源 `course_bookings.course_date/start_time/end_time`
- 上课地点：来源 `addresses.name`
- 取消原因：来源 `course_bookings.cancel_reason`

**消息模板字段映射**:
```javascript
{
  time18: {
    value: timeSlot      // 上课时间段
  },
  thing14: {
    value: addressName   // 上课地点，最大20字符
  },
  thing4: {
    value: cancelReason  // 取消原因，最大20字符
  }
}
```

### 场景四：上课提醒

**模板ID**: `92wWk3WlAV8raKdjYB9Ffb_x7G4LDfHrrcE0xoLvvO4`

**触发时机**: 课程开始前 2 小时（待确认、已确认的课程均提醒）

**业务场景**:
- 学员上课提醒 → 通知学员
- 教练上课提醒 → 通知教练

**字段映射**:
- 上课时间：来源 `course_bookings.course_date/start_time/end_time`
- 上课地点：来源 `addresses.name`

**消息模板字段映射**:
```javascript
{
  time18: {
    value: timeSlot      // 上课时间段
  },
  thing14: {
    value: addressName   // 上课地点，最大20字符
  }
}
```

## 数据库表结构

### subscribe_message_logs 表

用于记录所有订阅消息的发送情况，实现防重和追溯功能。

**创建脚本**：`scripts/004_create_subscribe_message_logs_table.js`

**字段说明**：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT UNSIGNED | 记录ID（主键） |
| template_id | VARCHAR(100) | 消息模板ID |
| template_type | VARCHAR(50) | 模板类型（BOOKING_CONFIRM, BOOKING_SUCCESS等） |
| business_type | VARCHAR(50) | 业务类型（course_booking, group_course等） |
| business_id | BIGINT UNSIGNED | 业务关联ID |
| receiver_user_id | BIGINT UNSIGNED | 接收人用户ID |
| receiver_openid | VARCHAR(100) | 接收人openid |
| message_data | JSON | 消息数据内容 |
| page_path | VARCHAR(200) | 跳转页面路径 |
| send_status | TINYINT(1) | 发送状态（0-发送中，1-成功，2-失败） |
| send_time | DATETIME | 发送时间 |
| error_code | VARCHAR(50) | 错误码 |
| error_message | TEXT | 错误信息 |
| retry_count | TINYINT UNSIGNED | 重试次数 |

**索引说明**：

- `uk_business_template_receiver`：唯一索引，防止重复发送
- `idx_business`：业务查询索引
- `idx_receiver_user`：用户消息查询索引  
- `idx_template_type`：模板类型统计索引
- `idx_send_status`：发送状态查询索引
- `idx_send_time`：时间范围查询索引

## 环境变量配置

在项目的 `.env` 文件中配置以下环境变量：

```bash
# 微信小程序配置
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

```

## 防重机制

系统通过独立的 `subscribe_message_logs` 表和本地配额检查实现多层消息防重机制：

### 防重策略

1. **配额预检查**（v2.0新增）：
   - 发送前检查 `user_subscribe_quotas` 表
   - 如果 `remaining_quota = 0`，直接跳过发送
   - 避免无效的微信API调用和日志记录

2. **唯一索引约束**：
   ```sql
   UNIQUE INDEX uk_business_template_receiver (
     business_type, business_id, template_type, receiver_user_id
   )
   ```
   - 确保同一业务、同一模板、同一接收人的消息只能发送一次

3. **发送前检查**：
   - 查询 `subscribe_message_logs` 表
   - 检查是否存在 `send_status = 1`（发送成功）的记录
   - 如已发送，跳过本次发送并记录日志

4. **并发防重**（v2.0新增）：
   - 在 `findOne` 后再次检查 `send_status`
   - 防止并发情况下的重复发送

5. **状态追踪**：
   - `0 - 发送中`：创建记录但尚未调用微信API
   - `1 - 发送成功`：微信API返回成功
   - `2 - 发送失败`：微信API返回失败或异常

### 记录内容

每次发送都会记录：
- 模板ID和类型
- 业务类型和ID
- 接收人信息（user_id 和 openid）
- 消息内容（JSON格式）
- 发送状态和时间
- 错误信息（如果失败）
- 重试次数

## 数据流程

### 预约确认提醒流程

```
学员/教练创建预约
    ↓
CourseController.createBooking()
    ↓
创建课程预约记录 (course_bookings)
    ↓
[异步] setImmediate
    ↓
SubscribeMessageService.sendBookingConfirmNotice()
    ↓
【v2.0新增】检查用户配额 (user_subscribe_quotas)
    ↓
配额为0？→ 跳过发送，返回 false
    ↓
检查是否已发送 (subscribe_message_logs)
    ↓
已发送？→ 跳过，返回 true
    ↓
未发送？→ 创建发送记录（状态：发送中）
    ↓
【v2.0新增】并发检查：记录已成功？→ 跳过，返回 true
    ↓
WeChatUtil.sendTemplateMessage()
    ↓
微信 API (subscribeMessage.send)
    ↓
更新发送状态（成功/失败）
    ↓
【v2.0新增】更新用户配额
    ↓
  成功：decreaseQuota()
  失败(43101)：resetQuota()
    ↓
用户收到订阅消息
```

### 预约成功通知流程

```
学员/教练确认预约
    ↓
CourseController.confirmCourse()
    ↓
更新课程状态为已确认 (booking_status = 2)
    ↓
[异步] setImmediate
    ↓
SubscribeMessageService.sendBookingSuccessNotice()
    ↓
检查是否已发送 (subscribe_message_logs)
    ↓
已发送？→ 跳过，返回 true
    ↓
未发送？→ 创建发送记录（状态：发送中）
    ↓
WeChatUtil.sendTemplateMessage()
    ↓
微信 API (subscribeMessage.send)
    ↓
更新发送状态（成功/失败）
    ↓
用户收到订阅消息
```

### 课程取消通知流程

```
课程被取消
    ↓
CourseController.cancelCourse()
    ↓
更新课程状态为已取消 (booking_status = 3)
    ↓
[异步] setImmediate
    ↓
SubscribeMessageService.sendCourseCancelNotice()
    ↓
检查是否已发送 (subscribe_message_logs)
    ↓
已发送？→ 跳过，返回 true
    ↓
未发送？→ 创建发送记录（状态：发送中）
    ↓
WeChatUtil.sendTemplateMessage()
    ↓
微信 API (subscribeMessage.send)
    ↓
更新发送状态（成功/失败）
    ↓
用户收到订阅消息
```

### 上课提醒流程

```
定时任务运行（每10分钟）
    ↓
扫描未来2小时内即将开始的课程（待确认/已确认）
    ↓
判断未开始、未取消课程
    ↓
[异步] 发送上课提醒给学员和教练
    ↓
用户收到订阅消息
```

## API 接口说明

### 1. 创建课程预约

**接口**: `POST /api/h5/courses`

**功能**: 创建课程预约，自动发送预约确认提醒

**请求示例**:
```json
{
  "coach_id": 1,
  "student_id": 2,
  "relation_id": 1,
  "course_date": "2025-11-10",
  "start_time": "19:00:00",
  "end_time": "20:00:00",
  "address_id": 1,
  "category_id": 0,
  "student_remark": "请准时到达",
  "coach_remark": ""
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "预约成功",
  "data": {
    "booking_id": 123,
    "booking_status": 1
  }
}
```

**订阅消息发送**:
- 发送时机：预约记录创建成功后
- 接收人：预约的对方（学员预约→通知教练，教练预约→通知学员）
- 消息类型：预约确认提醒

### 2. 确认课程预约

**接口**: `PUT /api/h5/courses/:id/confirm`

**功能**: 确认课程预约，自动发送预约成功通知

**请求示例**:
```bash
PUT /api/h5/courses/123/confirm
```

**响应示例**:
```json
{
  "code": 200,
  "message": "课程确认成功",
  "data": {
    "booking_id": 123,
    "booking_status": 2
  }
}
```

**订阅消息发送**:
- 发送时机：课程状态更新为已确认后
- 接收人：创建预约的人（教练确认→通知学员，学员确认→通知教练）
- 消息类型：预约成功通知

## 扩展新场景

如需添加新的订阅消息场景，请按以下步骤操作：

### 1. 在微信公众平台添加消息模板

1. 登录微信公众平台
2. 进入"订阅消息"管理
3. 选择合适的模板并添加
4. 获取模板ID

### 2. 在 SubscribeMessageService 中添加配置

```javascript
// 在 TEMPLATES 对象中添加新模板
static TEMPLATES = {
  BOOKING_CONFIRM: '...',
  BOOKING_SUCCESS: '...',
  YOUR_NEW_TEMPLATE: process.env.TEMPLATE_YOUR_NEW_TEMPLATE || 'template_id'
};

// 如需自定义跳转页面，在 PAGES 对象中添加
static PAGES = {
  COURSE_DETAIL: (courseId) => `pages/courseDetail/courseDetail?id=${courseId}`,
  YOUR_NEW_PAGE: (params) => `pages/your/page/index?param=${params}`
};
```

### 3. 实现发送方法

```javascript
/**
 * 场景X：您的场景描述
 * @param {Object} params - 参数对象
 * @returns {Promise<boolean>} 发送是否成功
 */
static async sendYourNewNotice(params) {
  try {
    // 1. 验证必要参数
    if (!params.requiredField) {
      logger.warn('发送XXX通知失败：缺少必要参数');
      return false;
    }

    // 2. 验证接收人的 openid
    if (!params.receiverUser.openid) {
      logger.warn('发送XXX通知失败：接收人没有 openid');
      return false;
    }

    // 3. 构建消息数据
    const messageData = {
      thing1: {
        value: params.field1.substring(0, 20)
      },
      // ... 其他字段
    };

    // 4. 确定跳转页面
    const page = this.PAGES.YOUR_NEW_PAGE(params.pageParam);

    // 5. 发送消息
    const result = await wechatUtil.sendTemplateMessage(
      params.receiverUser.openid,
      this.TEMPLATES.YOUR_NEW_TEMPLATE,
      messageData,
      page
    );

    if (result) {
      logger.info('发送XXX通知成功', { /* log data */ });
    }

    return result;
  } catch (error) {
    logger.error('发送XXX通知异常:', error);
    return false;
  }
}
```

### 4. 在业务逻辑中调用

```javascript
// 在相应的 Controller 方法中
setImmediate(async () => {
  try {
    await SubscribeMessageService.sendYourNewNotice({
      receiverUser: user,
      field1: data.field1,
      // ... 其他参数
    });
  } catch (error) {
    logger.error('发送XXX通知失败:', error);
  }
});
```

### 5. 更新环境变量

```bash
# 在 .env 文件中添加
TEMPLATE_YOUR_NEW_TEMPLATE=your_template_id
```

## 注意事项

1. **用户订阅**
   - 用户需要在小程序中主动订阅消息才能接收
   - 订阅消息有次数限制，每次订阅可发送一次
   - 建议在关键操作前引导用户订阅

2. **模板内容限制**
   - 遵循微信订阅消息内容规范
   - 字段类型严格匹配（thing、time、phrase、character_string 等）
   - 字段长度不超过限制（thing 类型最多20个字符）

3. **发送频率限制**
   - 避免短时间内向同一用户发送大量消息
   - 建议在批量发送时添加延迟（已实现：100ms/条）

4. **错误处理**
   - 消息发送失败不影响业务流程
   - 所有错误均记录日志，便于排查问题
   - 常见错误码：
     - 43101: 用户未订阅消息
     - 43107: 订阅消息能力封禁
     - 47003: 参数错误

5. **日志监控**
   - 定期检查日志中的消息发送情况
   - 关注发送失败率，及时调整策略
   - 日志路径：`src/shared/logs/`

## 测试建议

### 集成测试

1. 创建测试预约，验证预约确认提醒是否发送
2. 确认测试预约，验证预约成功通知是否发送
3. 检查日志，确认消息发送状态
4. 在小程序中验证消息接收情况

### 测试步骤

1. 使用 Postman 或小程序调用预约接口
2. 检查服务器日志：`tail -f src/shared/logs/$(date +%Y-%m-%d).log`
3. 查看是否有 "发送预约确认提醒成功" 或相关错误日志
4. 在小程序中查看是否收到订阅消息

## 相关文档

- [微信小程序订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-message-management/subscribe-message/sendMessage.html)
- [项目 API 文档](./API文档.md)
- [数据库设计文档](./database_design.md)

## 版本历史

- **v1.0.0** (2025-11-09)
  - 实现预约确认提醒功能
  - 实现预约成功通知功能
  - 集成异步消息发送机制

