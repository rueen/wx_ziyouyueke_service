# 课程分类功能说明

## 功能概述

本功能为微信约课服务新增了课程分类管理能力，支持教练创建多个课程分类，并按分类管理学员的课时数。

## 主要特性

### 1. 课程分类管理
- 教练可以创建、编辑、删除课程分类
- 每个教练都有一个默认分类（ID=0），不可删除
- 分类包含：ID、名称、描述

### 2. 按分类的课时管理
- 学员的课时按分类分别存储和管理
- 支持按分类增加、扣除课时
- 完全基于新的分类课时结构，不再依赖 remaining_lessons 字段

### 3. 预约时指定分类
- 课程预约时可以指定课程分类
- 完成课程时从对应分类的课时中扣除
- 取消已完成课程时恢复到对应分类

## 数据库变更

### 1. users 表新增字段
```sql
course_categories JSON COMMENT '课程分类配置'
-- 默认值：[{"id":0, "name":"默认", "desc": "默认分类"}]
```

### 2. student_coach_relations 表新增字段
```sql
lessons JSON COMMENT '按分类的课时数'
-- 格式：[{"category_id":0, "remaining_lessons": 0}]
```

### 3. course_bookings 表新增字段
```sql
category_id BIGINT UNSIGNED DEFAULT 0 COMMENT '课程分类ID'
```

## API 接口

### 课程分类管理

#### 获取分类列表
```
GET /api/h5/categories
```

#### 添加分类
```
POST /api/h5/categories
{
  "name": "瑜伽课程",
  "desc": "哈他瑜伽、阴瑜伽等"
}
```

#### 编辑分类
```
PUT /api/h5/categories/:id
{
  "name": "瑜伽课程",
  "desc": "更新后的描述"
}
```

#### 删除分类
```
DELETE /api/h5/categories/:id
```

#### 获取分类详情
```
GET /api/h5/categories/:id
```

### 课时管理

#### 获取我的学员列表（包含分类课时信息）
```
GET /api/h5/relations/my-students
```

#### 更新师生关系（包含分类课时管理）
```
PUT /api/h5/relations/:id
{
  "coach_remark": "教练备注",
  "student_remark": "学员备注",
  "category_lessons": [
    {"category_id": 0, "remaining_lessons": 10},
    {"category_id": 1, "remaining_lessons": 5}
  ]
}
```

**返回数据结构**：
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": 1,
        "student_id": 2,
        "coach_id": 1,
        "remaining_lessons": 15,
        "lessons": [{"category_id": 0, "remaining_lessons": 10}, {"category_id": 1, "remaining_lessons": 5}],
        "student": {
          "id": 2,
          "nickname": "学员昵称",
          "avatar_url": "头像URL",
          "phone": "手机号"
        },
        "category_lessons": [
          {
            "category": {"id": 0, "name": "默认", "desc": "默认分类"},
            "remaining_lessons": 10
          },
          {
            "category": {"id": 1, "name": "瑜伽", "desc": "瑜伽课程"},
            "remaining_lessons": 5
          }
        ]
      }
    ],
    "total": 10,
    "totalPages": 1,
    "page": 1,
    "pageSize": 10
  },
  "message": "获取我的学员列表成功"
}
```

**权限说明**：
- 教练可以更新 `coach_remark` 和 `category_lessons`
- 学员可以更新 `student_remark`
- 分类课时数据格式：`[{"category_id": 0, "remaining_lessons": 10}]`

### 课程预约

#### 预约课程（新增 category_id 参数）
```
POST /api/h5/courses
{
  "coach_id": 1,
  "student_id": 2,
  "category_id": 1,  // 新增：指定课程分类
  "course_date": "2025-09-20",
  "start_time": "10:00",
  "end_time": "11:00",
  "address_id": 1
}
```

## 数据迁移

### 运行迁移脚本
```bash
# 运行所有迁移脚本
node scripts/run-migrations.js

# 或单独运行
node scripts/005_add_course_categories_to_users.js
node scripts/006_add_lessons_to_student_coach_relations.js
node scripts/007_add_category_id_to_course_bookings.js
```

### 迁移内容
1. **005 脚本**：为所有用户添加默认课程分类
2. **006 脚本**：将现有课时迁移到新的分类结构中
3. **007 脚本**：为所有预约记录设置默认分类ID

## 业务流程

### 1. 教练创建分类
1. 教练登录后访问分类管理
2. 添加新的课程分类（如：瑜伽、普拉提等）
3. 系统自动为该教练的所有学员添加新分类的课时项（初始为0）

### 2. 学员预约课程
1. 学员选择教练和时间
2. 选择具体的课程分类
3. 创建预约记录，包含分类信息

### 3. 教练管理课时
1. 教练可以为学员在特定分类下添加课时
2. 查看学员在各分类下的课时余额
3. 课程完成后自动从对应分类扣除课时

### 4. 分类删除
1. 检查该分类下是否有学员的课时余额
2. 有余额则不允许删除
3. 删除成功后，移除所有学员关系中的该分类项

## 注意事项

### 1. 数据一致性
- 分类删除时会检查课时余额，确保数据安全
- 新用户注册时自动创建默认分类
- 课时管理完全基于分类结构，确保数据准确性

### 2. 数据结构迁移
- `remaining_lessons` 字段为过渡期保留，后期将删除
- 所有课时管理完全基于新的 `lessons` 字段
- 新功能不再依赖 `remaining_lessons` 字段

### 3. 权限控制
- 只有教练可以管理自己的课程分类
- 只有教练可以为学员添加课时
- 教练和学员都可以查看课时信息

## 错误处理

### 常见错误码
- `400`：参数验证失败
- `403`：权限不足
- `404`：资源不存在
- `500`：服务器内部错误

### 业务规则错误
- 分类名称重复
- 删除有课时余额的分类
- 课时数不足时无法扣除
- 不允许删除默认分类

## 测试建议

### 1. 功能测试
- 创建、编辑、删除分类
- 添加课时到不同分类
- 预约指定分类的课程
- 完成课程后检查课时扣除

### 2. 边界测试
- 尝试删除有课时的分类
- 尝试删除默认分类
- 添加负数课时
- 课时不足时的预约处理

### 3. 数据迁移测试
- 备份现有数据
- 运行迁移脚本
- 验证数据完整性
- 测试新旧功能兼容性

## 部署步骤

1. **备份数据库**
   ```bash
   mysqldump -u用户名 -p密码 数据库名 > backup.sql
   ```

2. **更新代码**
   ```bash
   git pull origin main
   npm install
   ```

3. **运行数据库迁移**
   ```bash
   node scripts/run-migrations.js
   ```

4. **重启服务**
   ```bash
   pm2 restart all
   ```

5. **验证功能**
   - 检查新接口是否正常工作
   - 验证现有功能未受影响
   - 测试数据迁移结果
