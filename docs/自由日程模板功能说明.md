# 自由日程模板功能说明

## 一、功能概述

为时间模板系统新增"自由日程模板"功能（`time_type = 2`），允许教练设置一个时间范围，学员和教练都可以在该范围内自由选择任意时间段进行预约。

**重要说明**：
- 每个教练只有一个时间模板（暂不支持创建多个）
- 学员和教练都可以主动发起课程预约

## 二、设计思路

### 2.1 时间模板类型说明

系统支持三种时间模板类型（`time_type`），使用不同的字段存储配置：

| time_type | 类型名称 | 使用字段 | 说明 |
|-----------|---------|---------|------|
| 0 | 全日程统一模板 | `time_slots` | 每天使用相同的固定时间段 |
| 1 | 按周历循环模板 | `week_slots` | 每周几使用不同的固定时间段 |
| 2 | 自由日程模板 | `free_time_range` | 在时间范围内可自由选择任意时间段 |

### 2.2 字段独立性

- 三种类型使用不同的字段存储配置，互不干扰
- 后端 `isTimeSlotAvailable` 方法会根据 `time_type` 自动选择对应字段进行验证
- 前端应根据 `time_type` 显示不同的配置界面和时间选择器

### 2.3 核心特性

**自由日程模板（time_type = 2）**：
- 教练设置一个时间范围（如 09:00 - 18:00）
- 学员/教练可在该范围内自由选择任意开始和结束时间
- 无最小或最大时长限制
- 不支持跨天预约（开始和结束时间必须在同一天）

## 三、数据结构

### 3.1 新增字段

在 `time_templates` 表中新增字段：

```sql
free_time_range JSON NULL COMMENT '自由日程时间范围，仅 time_type 为 2 时使用，格式：{"startTime":"09:00","endTime":"18:00"}'
```

### 3.2 数据格式

```json
{
  "id": 1,
  "coach_id": 123,
  "time_type": 2,
  "free_time_range": {
    "startTime": "09:00",
    "endTime": "18:00"
  },
  "min_advance_days": 1,
  "max_advance_days": 7,
  "max_advance_nums": 1,
  "date_slots": [
    { "id": 0, "text": "周日", "checked": true },
    { "id": 1, "text": "周一", "checked": true },
    { "id": 2, "text": "周二", "checked": true },
    { "id": 3, "text": "周三", "checked": true },
    { "id": 4, "text": "周四", "checked": true },
    { "id": 5, "text": "周五", "checked": true },
    { "id": 6, "text": "周六", "checked": true }
  ],
  "is_active": 1
}
```

## 四、API 接口

### 4.1 更新时间模板

**接口**: `PUT /api/h5/time-templates/:id`

**请求头**:
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| time_type | number | 否 | 时间类型：0-全日程统一，1-按周历循环，2-自由日程 |
| free_time_range | object | 否 | 自由日程时间范围（time_type=2 时使用） |
| free_time_range.startTime | string | 是 | 开始时间，格式：HH:mm（如 "09:00"） |
| free_time_range.endTime | string | 是 | 结束时间，格式：HH:mm（如 "18:00"） |
| time_slots | array | 否 | 固定时间段数组（time_type=0 时使用） |
| week_slots | array | 否 | 周历时间段配置（time_type=1 时使用） |
| min_advance_days | number | 否 | 最少提前预约天数 |
| max_advance_days | number | 否 | 最多可预约天数 |
| max_advance_nums | number | 否 | 同时段最多可预约人数 |
| date_slots | array | 否 | 可预约日期配置 |
| is_active | number | 否 | 是否启用：0-禁用，1-启用 |

**请求示例**（自由日程模板）:

```json
{
  "time_type": 2,
  "free_time_range": {
    "startTime": "09:00",
    "endTime": "18:00"
  },
  "min_advance_days": 1,
  "max_advance_days": 7,
  "max_advance_nums": 1,
  "date_slots": [
    { "id": 0, "text": "周日", "checked": true },
    { "id": 1, "text": "周一", "checked": true },
    { "id": 2, "text": "周二", "checked": true },
    { "id": 3, "text": "周三", "checked": true },
    { "id": 4, "text": "周四", "checked": true },
    { "id": 5, "text": "周五", "checked": true },
    { "id": 6, "text": "周六", "checked": true }
  ],
  "is_active": 1
}
```

**验证规则**:

- `free_time_range` 必须是对象格式，不能是数组
- 必须包含 `startTime` 和 `endTime` 字段
- 时间格式必须为 `HH:mm`（24小时制）
- `endTime` 必须大于 `startTime`
- 可以设置为 `null` 清空配置

**响应示例**:

```json
{
  "success": true,
  "message": "时间模板更新成功",
  "data": {
    "id": 1,
    "coach_id": 123,
    "time_type": 2,
    "free_time_range": {
      "startTime": "09:00",
      "endTime": "18:00"
    },
    "min_advance_days": 1,
    "max_advance_days": 7,
    "max_advance_nums": 1,
    "date_slots": [...],
    "is_active": 1,
    "createdAt": "2025-12-05T10:00:00.000Z",
    "updatedAt": "2025-12-05T10:00:00.000Z"
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "message": "free_time_range 结束时间必须大于开始时间"
}
```

### 4.2 获取时间模板

**接口**: `GET /api/h5/time-templates?coach_id={coach_id}`

**请求头**:
```
Authorization: Bearer {token}
```

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| coach_id | number | 否 | 教练ID，不传则查询当前用户的模板 |

**响应示例**:

```json
{
  "success": true,
  "message": "获取时间模板成功",
  "data": [
    {
      "id": 1,
      "coach_id": 123,
      "time_type": 2,
      "free_time_range": {
        "startTime": "09:00",
        "endTime": "18:00"
      },
      "min_advance_days": 1,
      "max_advance_days": 7,
      "max_advance_nums": 1,
      "time_slots": null,
      "week_slots": null,
      "date_slots": [...],
      "is_active": 1,
      "createdAt": "2025-12-05T10:00:00.000Z",
      "updatedAt": "2025-12-05T10:00:00.000Z"
    }
  ]
}
```

### 4.3 创建课程预约

**接口**: `POST /api/h5/courses`

**请求头**:
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| coach_id | number | 是 | 教练ID |
| student_id | number | 是 | 学员ID |
| course_date | string | 是 | 课程日期，格式：YYYY-MM-DD |
| start_time | string | 是 | 开始时间，格式：HH:mm |
| end_time | string | 是 | 结束时间，格式：HH:mm |
| category_id | number | 是 | 课程分类ID |
| booking_type | number | 是 | 预约类型：1-普通课程，2-卡片课程 |

**请求示例**（自由时间段预约）:

```json
{
  "coach_id": 123,
  "student_id": 456,
  "course_date": "2025-12-10",
  "start_time": "10:00",
  "end_time": "11:30",
  "category_id": 1,
  "booking_type": 1
}
```

**后端验证逻辑**:

- 自动根据教练的 `time_type` 进行验证
- `time_type = 0`：验证时间段是否在 `time_slots` 配置的固定时间段内
- `time_type = 1`：验证时间段是否在 `week_slots` 中对应星期几的时间段内
- `time_type = 2`：验证时间段是否在 `free_time_range` 的时间范围内
- 验证 `start_time < end_time`
- 验证日期是否在 `min_advance_days` 和 `max_advance_days` 范围内
- 验证该时间段预约人数是否超过 `max_advance_nums`

**响应示例**:

```json
{
  "success": true,
  "message": "课程预约成功",
  "data": {
    "id": 789,
    "coach_id": 123,
    "student_id": 456,
    "course_date": "2025-12-10",
    "start_time": "10:00",
    "end_time": "11:30",
    "booking_status": 1,
    // ... 其他字段
  }
}
```

**错误响应示例**:

```json
{
  "success": false,
  "message": "预约时间必须在 09:00 至 18:00 之间"
}
```

## 五、数据库迁移

执行以下命令添加 `free_time_range` 字段：

```bash
node scripts/migrations/add-free-time-range-field.js
```

迁移脚本会自动检查字段是否存在，避免重复执行。

## 六、注意事项

### 6.1 模板限制

- 每个教练只有一个时间模板
- 系统在用户注册时自动创建默认模板
- 前端应调用**更新接口**而非创建接口

### 6.2 预约权限

- 学员和教练都可以主动发起预约
- 预约创建后，需要双方确认

### 6.3 时间验证

- 开始和结束时间必须在同一天（不支持跨天预约）
- 时间格式为 HH:mm（24小时制）
- 时间精度为分钟级

### 6.4 向后兼容

- `free_time_range` 字段默认为 `null`
- 不影响现有 `time_type = 0` 和 `time_type = 1` 的功能
- 三种类型的配置字段可以同时存在，但只使用对应 `time_type` 的字段

## 七、常见问题

**Q1: 如何区分三种时间类型？**

A: 根据返回数据的 `time_type` 字段判断：
- `time_type = 0`：使用 `time_slots` 字段
- `time_type = 1`：使用 `week_slots` 字段  
- `time_type = 2`：使用 `free_time_range` 字段

**Q2: 自由日程模板可以设置多个时间范围吗？**

A: 不可以。`free_time_range` 只支持一个连续的时间范围。如需多个时间段，建议使用 `time_type = 0` 或 `time_type = 1`。

**Q3: 预约时如何验证时间段是否有效？**

A: 后端会自动根据 `time_type` 进行验证。前端只需提交 `start_time` 和 `end_time`，后端返回验证结果。

**Q4: 学员和教练预约的接口是否相同？**

A: 是的。学员和教练使用相同的 `POST /api/h5/courses` 接口，只是传入的 `coach_id` 和 `student_id` 不同。
